---
title: "Untitled"
author: "Cassandra Wattenburger"
date: "4/25/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
## Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Import data

```{r}
## Clusters
clust <- readRDS("../data_intermediate/NIFA_clusters.rds") %>% 
  mutate(cluster = as.character(cluster),
         cluster_name = case_when(cluster==1 ~ "competitor",
                            cluster==2 ~ "scarcity",
                            cluster==3 ~ "ruderal"))

## Growth
growth <- readRDS("../data_intermediate/NIFA_grests_final_ind.rds")

## Death
death <- readRDS("../data_intermediate/NIFA_dests_final_ind.rds")

## Paprica estimates
pap <- readRDS("../data_intermediate/NIFA_paprica_ests.rds")

## Incorporation profiles
incorp <- readRDS("../data_intermediate/NIFA_incorp_profiles.rds")

## Normalized abundances
abund <- readRDS("../data_intermediate/NIFA_norm_prepped.rds")

# Growth efficiency
greff <- readRDS("../data_intermediate/NIFA_greff.rds")

# Respiration
resp <- readRDS("../data_intermediate/NIFA_repiration.rds")
```

Reformat and combine:

```{r}
## Growth estimates
growth <- inner_join(growth, pap) %>% ## add paprica predictions
  mutate(start_abund_corr = start_abund/n16S, ## correct for 16S copy number
         end_abund_corr = end_abund/n16S,
         change_abund_corr = change_abund/n16S) %>% 
  select(everything(), -c(start_abund, end_abund, change_abund)) %>% 
  inner_join(clust) ## add cluster memberships

## Death estimates
death <- inner_join(death, pap) %>% ## add paprica predictions
  mutate(start_abund_corr = start_abund/n16S, ## correct for 16S copy number
         end_abund_corr = end_abund/n16S,
         change_abund_corr = change_abund/n16S) %>% 
  select(everything(), -c(start_abund, end_abund, change_abund)) %>% 
  inner_join(clust) ## add cluster memberships

## Normalized abundances
abund <- abund %>% 
  mutate(ASV = gsub("Ag[1-3]_|Meadow[1-3]_(.+)", "\\1", label)) %>% 
  inner_join(pap) %>% ## add paprica predictions
  filter(Isotope=="12C") %>% 
  select(label, Soil, Replicate, ASV, Day, norm_abund, n16S) %>% 
  mutate(norm_abund_corr = norm_abund/n16S) %>% ## correct for 16S copy number
  select(everything(), -c(norm_abund, n16S)) %>% 
  inner_join(clust) ## add cluster memberships

## Incorporation profiles
incorp <- incorp %>% 
  right_join(clust)
```

Respiration rates:

```{r}
# Time (days) elapsed per time point
time_steps <- data.frame(time_step = c(0, rep(1, 11), rep(2, 8), 3),
                         Day = sort(unique(resp$Day)))

# Calculate respiration rate mg/days
resp_rate <- resp %>% 
  left_join(time_steps) %>% 
  filter(Day != 0) %>% 
  mutate(resp_rate_c = mg_c / time_step,
         resp_rate_co2 = mg_co2 / time_step)
```

# Cluster characteristics

## Continuous variables

Visualize:

```{r}
# Continuous variables
# g
g_plot <- growth %>% 
  ggplot(aes(x=cluster_name, y=log(g), fill=Soil)) +
  scale_fill_manual(values=c("white", "gray")) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()
g_plot

# start day
start_plot <- growth %>% 
  ggplot(aes(x=cluster_name, y=log(start_day+1), fill=Soil)) +
  scale_fill_manual(values=c("white", "gray")) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()
start_plot

# change abund
chabund_plot <- growth %>% 
  ggplot(aes(x=cluster_name, y=log(change_abund_corr), fill=Soil)) +
  scale_fill_manual(values=c("white", "gray")) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()
chabund_plot
```

### Statistics

Summary:

```{r}
# mean and standard dev.
growth %>%
  group_by(cluster, Soil) %>%
  summarize(g_mean = mean(g),
            g_sd = sd(g),
            start_mean = mean(start_day),
            start_sd = sd(start_day),
            chabund_mean = mean(change_abund_corr),
            chabund_sd = sd(change_abund_corr),
            n16S_mean = mean(n16S),
            n16S_sd = sd(n16S),
            genome_mean = mean(genome_size, na.rm=TRUE),
            genome_sd = sd(genome_size, na.rm=TRUE))

incorp %>% 
  group_by(cluster, Soil) %>% 
  summarize(sub_mean = mean(substrate_num),
            sub_sd = sd(substrate_num))
```

Generation time:

```{r}
# Overall
gclust_lm <- lm(log(g) ~ cluster_name*Soil, data=growth)
hist(resid(gclust_lm)) # normal
plot(predict(gclust_lm), resid(gclust_lm)) # good enough
anova(gclust_lm)
# check ordering
gclust_lm2 <- lm(log(g) ~ Soil*cluster_name, data=growth)
anova(gclust_lm2)
# remains the same

# Contrasts
# cluster 1 vs 2
gclustcr_lm <- lm(log(g) ~ cluster_name, data=filter(growth, cluster_name %in% c("competitor", "ruderal")))
hist(resid(gclustcr_lm))
plot(predict(gclustcr_lm), resid(gclustcr_lm))
summary(gclustcr_lm)
# cluster 1 vs 3
gclustcs_lm <- lm(log(g) ~ cluster_name, data=filter(growth, cluster_name %in% c("competitor", "scarcity")))
hist(resid(gclustcs_lm))
plot(predict(gclustcs_lm), resid(gclustcs_lm))
summary(gclustcs_lm)
# cluster 2 vs 3
gclustrs_lm <- lm(log(g) ~ cluster_name, data=filter(growth, cluster_name %in% c("scarcity", "ruderal")))
hist(resid(gclustrs_lm))
plot(predict(gclustrs_lm), resid(gclustrs_lm))
summary(gclustrs_lm)
# multiple test correction
p.adjust(p=c(summary(gclustcr_lm)$coefficients[2,4], summary(gclustcs_lm)$coefficients[2,4], summary(gclustrs_lm)$coefficients[2,4]),
         method="holm", n=3)
```

Start day:

```{r}
# Overall
startclust_lm <- lm(log(start_day+1) ~ cluster_name*Soil, data=growth)
hist(resid(startclust_lm)) # normal
plot(predict(startclust_lm), resid(startclust_lm)) # good enough
anova(startclust_lm)
# check ordering
startclust_lm2 <- lm(log(start_day+1) ~ Soil*cluster_name, data=growth)
anova(startclust_lm2)
# cluster remains significant either way, soil does not

# Contrasts
startclustcr_lm <- lm(log(start_day+1) ~ cluster_name, data=filter(growth, cluster_name %in% c("competitor", "ruderal")))
hist(resid(startclustcr_lm))
plot(predict(startclustcr_lm), resid(startclustcr_lm))
anova(startclustcr_lm)

startclustcs_lm <- lm(log(start_day+1) ~ cluster_name, data=filter(growth, cluster_name %in% c("ruderal", "scarcity")))
hist(resid(startclustcs_lm))
plot(predict(startclustcs_lm), resid(startclustcs_lm))
anova(startclustcs_lm)

startclustrs_lm <- lm(log(start_day+1) ~ cluster_name, data=filter(growth, cluster_name %in% c("ruderal", "scarcity")))
hist(resid(startclustrs_lm))
plot(predict(startclustrs_lm), resid(startclustrs_lm))
anova(startclustrs_lm)

# P adjustment
p.adjust(p=c(summary(startclustcr_lm)$coefficients[2,4], summary(startclustcs_lm)$coefficients[2,4], summary(startclustrs_lm)$coefficients[2,4]),
         method="holm", n=3)
```

Change abundance:

```{r}
# Overall
chabundclust_lm <- lm(log(change_abund_corr) ~ cluster_name*Soil, data=growth)
hist(resid(chabundclust_lm)) # normal
plot(predict(chabundclust_lm), resid(chabundclust_lm)) # good enough
anova(chabundclust_lm)
# check ordering
chabundclust_lm2 <- lm(log(change_abund_corr) ~ Soil*cluster_name, data=growth)
anova(chabundclust_lm2)

# Contrasts
## Between soils
chabundc_lm <- lm(log(change_abund_corr) ~ Soil, data=filter(growth, cluster_name=="competitor"))
hist(resid(chabundc_lm))
plot(predict(chabundc_lm), resid(chabundc_lm))
anova(chabundc_lm)

chabundr_lm <- lm(log(change_abund_corr) ~ Soil, data=filter(growth, cluster_name=="ruderal"))
hist(resid(chabundr_lm))
plot(predict(chabundr_lm), resid(chabundr_lm))
anova(chabundr_lm)

chabunds_lm <- lm(log(change_abund_corr) ~ Soil, data=filter(growth, cluster_name=="scarcity"))
hist(resid(chabunds_lm))
plot(predict(chabunds_lm), resid(chabunds_lm))
anova(chabunds_lm)

# Between clusters (soil agnostic)
chabundcr_lm <- lm(log(change_abund_corr) ~ cluster_name, data=filter(growth, cluster_name %in% c("competitor", "ruderal")))
hist(resid(chabundcr_lm))
plot(predict(chabundcr_lm), resid(chabundcr_lm))
anova(chabundcr_lm)

chabundcs_lm <- lm(log(change_abund_corr) ~ cluster_name, data=filter(growth, cluster_name %in% c("competitor", "scarcity")))
hist(resid(chabundcs_lm))
plot(predict(chabundcs_lm), resid(chabundcs_lm))
anova(chabundcs_lm)

chabundrs_lm <- lm(log(change_abund_corr) ~ cluster_name, data=filter(growth, cluster_name %in% c("ruderal", "scarcity")))
hist(resid(chabundrs_lm))
plot(predict(chabundrs_lm), resid(chabundrs_lm))
anova(chabundcs_lm)


# multiple test correction
p.adjust(p=c(summary(chabundc_lm)$coefficients[2,4], summary(chabunds_lm)$coefficients[2,4], summary(chabundr_lm)$coefficients[2,4],
         summary(chabundcr_lm)$coefficients[2,4], summary(chabundcs_lm)$coefficients[2,4], summary(chabundrs_lm)$coefficients[2,4]),
         method="holm", n=6)
```

## Labelling profiles

Substrate number:

```{r}
# substrate number
subnum_plot <- incorp %>% 
  ggplot(aes(x=cluster, y=substrate_num, shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_jitter(height=0.1) +
  theme_test()
subnum_plot

subnum_plot2 <- incorp %>% 
  group_by(Soil, cluster_name, substrate_num) %>% 
  summarize(count=n()) %>% 
  ggplot(aes(x=substrate_num, y=count, fill=Soil)) +
  scale_fill_manual(values=c("white", "gray")) +
  geom_col(position="dodge", color="black") +
  facet_wrap(~cluster_name) +
  theme_test()
subnum_plot2
```

Substrate preference:

```{r}
# Totals substrate*cluster
subclust_totals <- incorp %>% 
  pivot_longer(cols=cellulose:xylose, names_to="substrate", values_to="labelled") %>% 
  group_by(cluster_name, substrate) %>% 
  summarize(total=n())

subclust_totals

# Calculate poportions by cluster and substrate
subclust_prop <- incorp %>% 
  pivot_longer(cols=cellulose:xylose, names_to="substrate", values_to="labelled") %>% 
  group_by(cluster_name, substrate, labelled) %>% 
  summarize(count=n()) %>% 
  inner_join(subclust_totals) %>% 
  mutate(prop = count/total)

subclust_prop
```

Visualize:

```{r}
# Counts
subclust_prop %>% 
  filter(labelled=="yes") %>% 
  ggplot(aes(x=substrate, y=count, color=cluster_name)) +
  geom_point() +
  geom_line(aes(group=cluster_name)) +
  labs(y="Number labelled") +
  theme_test()

# Proportions
subclust_prop %>% 
  filter(labelled=="yes") %>% 
  ggplot(aes(x=substrate, y=prop, color=cluster_name)) +
  geom_point() +
  geom_line(aes(group=cluster_name)) +
  labs(y="Proportion labelled") +
  theme_test()
```

### Statistics

Contingency tables

```{r}
# Reformat
# Each column should be a cluster, each row a substrate, "yes" counts
clustsub_mx <- subclust_prop %>% 
  filter(labelled=="yes") %>% 
  select(cluster_name, substrate, count) %>% 
  pivot_wider(names_from=cluster_name, values_from=count) %>% 
  column_to_rownames(var="substrate") %>% 
  as.matrix

clustsub_mx # large cell values, appropriate for chi-squared
rowSums(clustsub_mx) # fairly even, appropriate for chi-squared
colSums(clustsub_mx) # very uneven, Fisher's more appropriate than chi-squared

# Fisher exact tests
# Contrasts
fish12 <- fisher.test(clustsub_mx[,1:2], simulate.p.value = TRUE, B = 1e6) # cluster 1 vs 2
fish13 <- fisher.test(clustsub_mx[,c(1,3)], simulate.p.value = TRUE, B = 1e6) # cluster 1 vs 3
fish23 <- fisher.test(clustsub_mx[,2:3], simulate.p.value = TRUE, B = 1e6) # cluster 2 vs 3
# Multiple test adjustment
p.adjust(p=c(fish12$p.value, fish13$p.value, fish23$p.value), method="holm", n=3)
```

## Substrate preference

```{r}
incorp %>% 
  select(ASV:xylose, cluster) %>% 
  pivot_longer(cols=cellulose:xylose, names_to="substrate", values_to="labelled") %>% 
  filter(labelled=="yes") %>% 
  group_by(Soil, cluster, substrate) %>% 
  summarize(total=n()) %>% 
  ggplot(aes(x=substrate, y=total, fill=cluster)) +
  geom_col(position="dodge") +
  facet_wrap(~cluster) +
  theme_test() +
  theme(axis.text.x=element_text(angle=45, hjust=1))

# Proportion
incorp_clust_totals <- incorp %>% 
  select(ASV:xylose, cluster) %>% 
  pivot_longer(cols=cellulose:xylose, names_to="substrate", values_to="labelled") %>% 
  filter(labelled=="yes") %>% 
  group_by(cluster) %>% 
  summarize(total=n()) %>% 
  ungroup()

incorp %>% 
  select(ASV:xylose, cluster) %>% 
  pivot_longer(cols=cellulose:xylose, names_to="substrate", values_to="labelled") %>% 
  filter(labelled=="yes") %>% 
  group_by(cluster, substrate) %>% 
  summarize(count=n()) %>%
  ungroup() %>% 
  inner_join(incorp_clust_totals) %>% 
  mutate(prop = count/total) %>% 
  ggplot(aes(x=cluster, y=prop, fill=substrate)) +
  geom_col() +
  theme_test()
```

## Day of first use

```{r}
incorp %>% 
  select(ASV, Soil, cluster, cellulose_firstday:xylose_firstday) %>% 
  pivot_longer(cols=cellulose_firstday:xylose_firstday, names_to="substrate", values_to="first_day") %>% 
  mutate(substrate = gsub("([a-z]+)_firstday", "\\1", substrate)) %>% 
  filter(!is.na(first_day)) %>% # remove non-incorporators
  group_by(Soil, cluster, substrate, first_day) %>% 
  summarize(count=n()) %>% 
  ggplot(aes(x=first_day, y=count, fill=cluster)) +
  geom_col(position="dodge") +
  facet_wrap(~substrate) +
  theme_test()
```

# Soils comparisons

## Cluster total abundances

### Community level

Calculate cluster sums:

```{r}
## Total abundance of each cluster over time
abund_total <- abund %>% 
  group_by(Soil, Day, Replicate, cluster_name) %>% 
  summarize(abund_total = sum(norm_abund_corr)) %>% 
  ungroup()
abund_total
```

Visualize:

```{r}
## Visualize
abund_total %>% 
  ggplot(aes(x=Day, y=log(abund_total))) +
  geom_point(aes(fill=cluster_name), color="black", pch=21, size=3) +
  scale_fill_manual(values=c("#502A5A", "#25908C", "#FDE725")) +
  geom_smooth(aes(group=cluster_name, fill=cluster_name), color="black") +
  facet_wrap(~Soil) +
  theme_test() +
  theme(axis.text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.title = element_text(size=12))
```

Average across day:

```{r}
abund_total_day <- abund_total %>%
  group_by(Soil, Replicate, cluster_name) %>% 
  summarize(abund_total = mean(abund_total)) %>% 
  ungroup()
abund_total_day
```

Visualize:

```{r}
abund_total_day %>% 
  ggplot(aes(x=Soil, y=log(abund_total), color=cluster_name)) +
  geom_jitter(aes(fill=cluster_name), color="black", pch=21, size=5, width=0.1, height=0) +
  scale_fill_manual(values=c("#502A5A", "#25908C", "#FDE725")) +
  theme_test() +
  theme(axis.text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.title = element_text(size=12))
```

#### Statistics

On day-averaged data:

```{r}
abundtot_lm <- lm(log(abund_total) ~ Soil + cluster_name + Soil*cluster_name, data=abund_total_day)
hist(resid(abundtot_lm)) ## normal
plot(predict(abundtot_lm), resid(abundtot_lm)) ## heteroskedastic
## This is trickey because log removes normality but fixes heteroskedasticity, and viceversa

# Contrasts of interest
comp_lm <- lm(log(abund_total) ~ Soil, data = filter(abund_total_day, cluster_name=="competitor"))
hist(resid(comp_lm)) # not normal
plot(predict(comp_lm), resid(comp_lm)) # homoskedastic w/log transform
# Switch to non-parametric test








## I'm going to use welch anova on the heteroskeastic data, because it seems to perform well in cases like this: https://scholarscompass.vcu.edu/etd/3985/




# Overall
clustag_wanova <- oneway.test(abund_total ~ cluster_name, data=filter(abund_total_day), var.equal=FALSE)
clustag_wanova
`clustmead_wanova <- oneway.test(abund_total ~ cluster_name, data=filter(abund_total_day, Soil=="Meadow"), var.equal=FALSE)
clustmead_wanova`

# Contrasts of interest
## within soils
agcr_welch <- t.test(abund_total ~ cluster_name, data=filter(abund_total_day, Soil=="Ag" & cluster_name %in% c("competitor", "ruderal")), var.equal=FALSE)
agcs_welch <- t.test(abund_total ~ cluster_name, data=filter(abund_total_day, Soil=="Ag" & cluster_name %in% c("competitor", "scarcity")), var.equal=FALSE)
agrs_welch <- t.test(abund_total ~ cluster_name, data=filter(abund_total_day, Soil=="Ag" & cluster_name %in% c("ruderal", "scarcity")), var.equal=FALSE)
meadcr_welch <- t.test(abund_total ~ cluster_name, data=filter(abund_total_day, Soil=="Meadow" & cluster_name %in% c("competitor", "ruderal")), var.equal=FALSE)
meadcs_welch <- t.test(abund_total ~ cluster_name, data=filter(abund_total_day, Soil=="Meadow" & cluster_name %in% c("competitor", "scarcity")), var.equal=FALSE)
meadrs_welch <- t.test(abund_total ~ cluster_name, data=filter(abund_total_day, Soil=="Meadow" & cluster_name %in% c("ruderal", "scarcity")), var.equal=FALSE)
## between soils
clustc_welch <- t.test(abund_total ~ Soil, data=filter(abund_total_day, cluster_name=="competitor"), var.equal=FALSE)
clustr_welch <- t.test(abund_total ~ Soil, data=filter(abund_total_day, cluster_name=="ruderal"), var.equal=FALSE)
clusts_welch <- t.test(abund_total ~ Soil, data=filter(abund_total_day, cluster_name=="scarcity"), var.equal=FALSE)
## P adjustment
p.adjust(p=c(agcr_welch$p.value, agcs_welch$p.value, agrs_welch$p.value, meadcr_welch$p.value, meadcs_welch$p.value, meadrs_welch$p.value,
             clustc_welch$p.value, clustr_welch$p.value, clusts_welch$p.value),
         method="holm", n=9)
```


# WIP BELOW REDO

### ASV-level

```{r}
## Average ASV abundance over time
abund_asv <- abund %>% 
  group_by(ASV, Soil, Day, cluster) %>% # average ASVs
  summarize(norm_abund_corr = mean(norm_abund_corr)) %>% 
  ungroup() %>% 
  group_by(ASV, Soil, cluster) %>% # average across days
  summarize(abund = sum(norm_abund_corr)) %>% 
  ungroup()
abund_asv
```

Visualize:

```{r}
abund_asv %>% 
  ggplot(aes(x=Soil, y=log(abund), color=cluster)) +
  geom_jitter() +
  geom_boxplot(aes(color=cluster), position="dodge") +
  theme_test()
```

## Cluster proportions

Proportion of total abundance per soil

```{r}
## Calculate proportions
abund_total_overall <- abund_total %>% 
  group_by(Soil, Day, Replicate) %>% 
  summarize(overall_total = sum(abund_total))

abund_prop <- left_join(abund_total, abund_total_overall) %>% 
  mutate(abund_prop = abund_total/overall_total,
         cluster = as.character(cluster))
abund_prop
```

Visualize:

```{r}
abund_prop %>% 
  ggplot(aes(x=Day, y=abund_prop, color=cluster)) +
  geom_point() + 
  facet_wrap(~Soil) +
  geom_smooth(aes(color=cluster)) +
  theme_test()
```

### Group 1:3

```{r}
## Calculate proportions
grp13_ratio <- abund_total %>% 
  group_by(Soil, Day, cluster) %>% # average replicates
  summarize(abund_total = mean(abund_total)) %>% 
  ungroup() %>% 
  filter(cluster %in% c(1,3)) %>% 
  pivot_wider(id_cols=c(Soil, Day), names_from=cluster, values_from=abund_total) %>% 
  mutate(ratio13 = `1`/`3`)

grp13_ratio
```

Visualize:

```{r}
grp13_ratio %>% 
  ggplot(aes(x=Day, y=ratio13, color=Soil)) +
  geom_point() +
  geom_smooth() +
  theme_test()
```

Growing only:

```{r}
## Calculate proportions actively growing only
grp13_ratio_grow <- abund_total %>% 
  left_join(growth) %>% 
  mutate(keep = if_else(Day >= start_day & Day <= end_day, "yes", "no")) %>% 
  filter(keep=="yes") %>% 
  group_by(Soil, Day, cluster) %>% # average replicates
  summarize(abund_total = mean(abund_total)) %>% 
  ungroup() %>% 
  filter(cluster %in% c(1,3)) %>% 
  pivot_wider(id_cols=c(Soil, Day), names_from=cluster, values_from=abund_total) %>% 
  mutate(ratio13 = `1`/`3`)

grp13_ratio_grow
```

Visualize:

```{r}
grp13_ratio_grow %>% 
  ggplot(aes(x=Day, y=ratio13, color=Soil)) +
  geom_point() +
  geom_smooth() +
  theme_test()
```

Vs. greff:

```{r}
# All abundance
greff %>% 
  group_by(Soil, Day) %>% # average replicates
  summarize(greff = mean(greff),
            mg_co2 = mean(mg_co2)) %>% 
  inner_join(grp13_ratio) %>% 
  ggplot(aes(x=ratio13, y=greff, color=Soil)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()

# Growing abundance
greff %>% 
  group_by(Soil, Day) %>% # average replicates
  summarize(greff = mean(greff),
            mg_co2 = mean(mg_co2)) %>% 
  inner_join(grp13_ratio_grow) %>% 
  ggplot(aes(x=ratio13, y=greff, color=Soil)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()
```


### WIP Statistics

## Cluster change abundances

ASV-level

```{r}
## Calculate change in abundance for each cluster member
clust_chabund <- growth %>% 
  group_by(Soil, ASV, cluster) %>% ## average across replicates
  summarize(chabund = mean(change_abund_corr)) %>% 
  ungroup()

## Visualize
clust_chabund %>% 
  ggplot(aes(y=log(chabund), x=Soil, color=cluster)) +
  geom_jitter(aes(fill=cluster), color="black", pch=21, size=3) +
  geom_boxplot(aes(fill=cluster), position="dodge", color="black") +
  scale_fill_manual(values=c("#502A5A", "#25908C", "#FDE725")) +
  facet_wrap(~cluster) +
  theme_test() +
  theme(axis.text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.title = element_text(size=12))

```

#### Statistics

```{r}
## Overall
clustchabund_lm <- lm(log(chabund) ~ Soil + cluster + Soil*cluster, data=clust_chabund)
hist(resid(clustchabund_lm)) ## normal af
plot(predict(clustchabund_lm), resid(clustchabund_lm)) ## homoskedastic
anova(clustchabund_lm)
## Contrasts
## Cluster 1
clust1_lm <- lm(log(chabund) ~ Soil, data=filter(clust_chabund, cluster==1))
hist(resid(clust1_lm))
plot(predict(clust1_lm), resid(clust1_lm))
summary(clust1_lm)
## Cluster 2
clust2_lm <- lm(log(chabund) ~ Soil, data=filter(clust_chabund, cluster==2))
hist(resid(clust2_lm))
plot(predict(clust2_lm), resid(clust2_lm))
summary(clust2_lm)
## cluster 3
clust3_lm <- lm(log(chabund) ~ Soil, data=filter(clust_chabund, cluster==3))
hist(resid(clust3_lm))
plot(predict(clust3_lm), resid(clust3_lm))
summary(clust3_lm)
## P adjustment
p.adjust(p=c(summary(clust1_lm)$coefficients[2,4], summary(clust2_lm)$coefficients[2,4], summary(clust3_lm)$coefficients[2,4]),
         method="holm", n=3)
```

## Diversity

```{r}
clust_rich <- growth %>% 
  group_by(Soil, Replicate, cluster) %>% 
  summarize(richness = n()) %>% 
  ungroup()

clust_rich %>% 
  ggplot(aes(x=Soil, y=richness)) +
  #geom_jitter(aes(fill=cluster), color="black", pch=21, size=3, height=0, width=0.1) +
  geom_boxplot(aes(fill=cluster), position="dodge") +
  scale_fill_manual(values=c("#502A5A", "#25908C", "#FDE725")) +
  theme_test() +
  theme(axis.text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.title = element_text(size=12))
```

### Statistics

```{r}
clust1_lm <- lm(richness ~ Soil, data=clust_rich[clust_rich$cluster==1,])
hist(resid(clust1_lm))
plot(predict(clust1_lm), resid(clust1_lm)) # heteroskedastic
# Switch to welch t-tests
clust1_welch <- t.test(richness ~ Soil, data=clust_rich[clust_rich$cluster==1,], var.equal=FALSE)
clust2_welch <- t.test(richness ~ Soil, data=clust_rich[clust_rich$cluster==2,], var.equal=FALSE)
clust3_welch <- t.test(richness ~ Soil, data=clust_rich[clust_rich$cluster==3,], var.equal=FALSE)
# P adjustment
p.adjust(p=c(clust1_welch$p.value, clust2_welch$p.value, clust3_welch$p.value), method="holm", n=3)
```

# Death

## Death x cluster

```{r}
## Calculate ASV averages
death_chabundh <- death %>% 
  group_by(Soil, ASV, cluster) %>%  ## asv averages a/c replicates
  summarize(h = mean(h),
            chabund = mean(change_abund_corr)) %>% 
  ungroup()

## Visualize
## h 
death_chabundh %>% 
  ggplot(aes(x=cluster, y=log(h), color=Soil)) +
  geom_boxplot(aes(color=Soil)) +
  geom_point(alpha=0.5) +
  theme_test()

## chabund
death_chabundh %>% 
  ggplot(aes(x=cluster, y=log(abs(chabund)), color=Soil)) +
  geom_boxplot(aes(color=Soil)) +
  geom_point(alpha=0.5) +
  theme_test()
```

### WIP Statistics

# Growth efficiency

```{r}
greff_abunds <- greff %>% 
  select(Soil:Day, mg_co2, greff) %>% 
  inner_join(abund_total) %>% 
  full_join(abund_prop) %>% 
  group_by(Soil, Day, cluster) %>% 
  summarize(greff = mean(greff),
            abund_total = mean(abund_total)) %>% # average replicates
  ungroup()
```

```{r}
# Across soils
greff_abunds %>% 
  ggplot(aes(x=greff, y=log(abund_total), color=cluster)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()
```


```{r}
# Each soil
# Total abundances
greff_abunds %>% 
  ggplot(aes(x=greff, y=abund_total, color=cluster)) +
  geom_point() +
  facet_wrap(~Soil, scales="free") +
  geom_smooth(method="lm") +
  theme_test()

greff_abunds %>%
  ggplot(aes(x=greff, y=abund_total, color=cluster)) +
  geom_point() +
  facet_wrap(Soil~cluster, scales="free") +
  geom_smooth(method="lm") +
  theme_test()
```

## Statistics

```{r}
# Cluster total in relation to growth efficiency
clust1_cor <- cor.test(greff_abunds[greff_abunds$cluster==1,]$greff, 
                    greff_abunds[greff_abunds$cluster==1,]$abund_total, method="pearson")
clust2_cor <- cor.test(greff_abunds[greff_abunds$cluster==2,]$greff, 
                    greff_abunds[greff_abunds$cluster==2,]$abund_total, method="pearson")
clust3_cor <- cor.test(greff_abunds[greff_abunds$cluster==3,]$greff, 
                    greff_abunds[greff_abunds$cluster==3,]$abund_total, method="pearson")

# p adjustment
p.adjust(p=c(clust1_cor$p.value, clust2_cor$p.value, clust3_cor$p.value), method="holm", n=3)
```

## WIP Cluster total abundance - growing only

I'm wondering if non-growing is skewing greff interpretation?

Total abundance of growing taxa

# BOOKMARK
```{r}
abund_total_grow <- abund %>% 
  inner_join(growth) %>% 
  left_join(clust) %>% 
  mutate(keep = if_else(Day >= start_day & Day <= end_day, "yes", "no")) %>% # only keep abundances within growing periods
  filter(keep=="yes") %>% 
  select(Soil, Replicate, Day, ASV, cluster, norm_abund_corr, start_day, end_day) %>% 
  group_by(Soil, Replicate, Day, cluster) %>% 
  summarize(abund_total = sum(norm_abund_corr)) %>% 
  ungroup()

greff_total_grow <- abund_total_grow %>% 
  left_join(greff) %>% 
  group_by(Soil, Day, cluster) %>% 
  summarize(greff = mean(greff),
            abund_total = sum(abund_total)) %>% 
  ungroup() %>% 
  filter(!is.na(greff)) # remove days not included in greff calculation

greff_total_grow
```

Visualize

```{r}
greff_total_grow %>% 
  ggplot(aes(x=greff, y=log(abund_total), color=cluster)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()

greff_total_grow %>% 
  ggplot(aes(y=greff, x=abund_total, color=cluster)) +
  geom_point(aes(fill=cluster), color="black", pch=21, size=3) +
  scale_fill_manual(values=c("#502A5A", "#25908C", "#FDE725")) +
  geom_smooth(method="lm", aes(color=cluster), linetype=2, alpha=0.2) +
  scale_color_manual(values=c("#502A5A", "#25908C", "#FDE725")) +
  facet_wrap(~Soil, scales="free", nrow=2) +
  theme_test() +
  theme(axis.text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.title = element_text(size=12))
```

### Statistics

```{r}
# Each separately
ag1_cor <- cor.test(greff_total_grow[greff_total_grow$Soil=="Ag" & greff_total_grow$cluster==1,]$abund_total, 
                    greff_total_grow[greff_total_grow$Soil=="Ag" & greff_total_grow$cluster==1,]$greff, method="pearson")
ag2_cor <- cor.test(greff_total_grow[greff_total_grow$Soil=="Ag" & greff_total_grow$cluster==2,]$abund_total, 
                    greff_total_grow[greff_total_grow$Soil=="Ag" & greff_total_grow$cluster==2,]$greff, method="pearson")
ag3_cor <- cor.test(greff_total_grow[greff_total_grow$Soil=="Ag" & greff_total_grow$cluster==3,]$abund_total, 
                    greff_total_grow[greff_total_grow$Soil=="Ag" & greff_total_grow$cluster==3,]$greff, method="pearson")
mead1_cor <- cor.test(greff_total_grow[greff_total_grow$Soil=="Meadow" & greff_total_grow$cluster==1,]$abund_total, 
                    greff_total_grow[greff_total_grow$Soil=="Meadow" & greff_total_grow$cluster==1,]$greff, method="pearson")
mead2_cor <- cor.test(greff_total_grow[greff_total_grow$Soil=="Meadow" & greff_total_grow$cluster==2,]$abund_total, 
                    greff_total_grow[greff_total_grow$Soil=="Meadow" & greff_total_grow$cluster==2,]$greff, method="pearson")
mead3_cor <- cor.test(greff_total_grow[greff_total_grow$Soil=="Meadow" & greff_total_grow$cluster==3,]$abund_total, 
                    greff_total_grow[greff_total_grow$Soil=="Meadow" & greff_total_grow$cluster==3,]$greff, method="pearson")
# P adjustment
p.adjust(p=c(ag1_cor$p.value, ag2_cor$p.value, ag3_cor$p.value, mead1_cor$p.value, mead2_cor$p.value, mead3_cor$p.value),
         method="holm", n=6)
```

