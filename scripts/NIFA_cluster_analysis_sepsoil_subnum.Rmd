---
title: "NIFA - cluster analysis"
author: "Cassandra Wattenburger"
date: "5/8/2023"
output: githib_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
## Clear working directory, load in packages, generate package info
rm(list=ls())

#library("tidyverse") # deseq2 install broke and can't be bothered to troubleshoot
library("tidyr")
library("dplyr")
library("tibble")
library("readr")
library("forcats")
library("ggplot2")

sessionInfo()
```

# Import data

```{r}
## Clusters
clust <- readRDS("../data_intermediate/NIFA_cluster_sepsoil_subnum.rds")

## Growth
growth <- readRDS("../data_intermediate/NIFA_grests_final_ind.rds")

# Death 
death <- readRDS("../data_intermediate/NIFA_dests_final_ind.rds")

## Taxonomy
tax <- read_tsv("../data_amplicon/NIFA2/final/NIFA2.taxonomy-final.tsv")

## Paprica estimates
pap <- readRDS("../data_intermediate/NIFA_paprica_ests.rds")

## Incorporation profiles
incorp <- readRDS("../data_intermediate/NIFA_incorp_profiles.rds")

## Normalized abundances
abund <- readRDS("../data_intermediate/NIFA_norm_prepped.rds")

# Growth efficiency
greff <- readRDS("../data_intermediate/NIFA_greff.rds")

# Respiration
resp <- readRDS("../data_intermediate/NIFA_repiration.rds")
```

# Cluster characteristics

## Growth metrics

Reformat/calculate:

```{r}
# Full dataset
growth2 <- inner_join(growth, pap) %>% ## add paprica predictions
  mutate(start_abund_corr = start_abund/n16S, ## correct for 16S copy number
         end_abund_corr = end_abund/n16S,
         change_abund_corr = change_abund/n16S,
         length = end_day-start_day) %>% # calculate length of growth
  select(everything(), -c(label, slope:k, start_pt, end_pt, start_abund:change_abund)) %>% 
  left_join(clust)
growth2 <- growth2[complete.cases(growth2),]

# ASV averages
growth_asv <- inner_join(growth, pap) %>% ## add paprica predictions
  mutate(start_abund_corr = start_abund/n16S, ## correct for 16S copy number
         end_abund_corr = end_abund/n16S,
         change_abund_corr = change_abund/n16S,
         length = end_day-start_day) %>% # calculate length of growth
  select(everything(), -c(label, slope:k, start_pt, end_pt, start_abund:change_abund)) %>% 
  group_by(Soil, ASV) %>% # ASV averages
  summarise_at(vars(g:length), mean, na.rm = TRUE) %>% 
  inner_join(clust) ## add cluster memberships
```

Visualize:

```{r}
# g
growth_asv %>% 
  ggplot(aes(x=cluster, y=log(g), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# start day
growth_asv %>% 
  ggplot(aes(x=cluster, y=log(start_day+1), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# end day
growth_asv %>% 
  ggplot(aes(x=cluster, y=log(end_day), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# length
growth_asv %>% 
  ggplot(aes(x=cluster, y=log(length), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# Start abund
growth_asv %>% 
  ggplot(aes(x=cluster, y=log(start_abund_corr), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# change abund
growth_asv %>% 
  ggplot(aes(x=cluster, y=log(change_abund_corr), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()
```

Nice figures:

```{r, eval=FALSE}
# Nice names
growth_asv_plot <- growth_asv %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agriculture", "Meadow"))

# g
g_plot <- growth_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(g), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=14),
      axis.text = element_text(size=12),
      legend.title = element_text(size=14),
      axis.title.x = element_blank(),
      legend.text = element_text(size=12))
g_plot

# change abund
chabund_plot <- growth_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(change_abund_corr), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=14),
      axis.text = element_text(size=12),
      legend.title = element_text(size=14),
      axis.title.x = element_blank(),
      legend.text = element_text(size=12))
chabund_plot

# lag
lag_plot <- growth_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(start_day+1), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=14),
      axis.text = element_text(size=12),
      legend.title = element_text(size=14),
      axis.title.x = element_blank(),
      legend.text = element_text(size=12))
lag_plot

# length
length_plot <- growth_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(length), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=14),
      axis.text = element_text(size=12),
      legend.title = element_text(size=14),
      axis.title.x = element_blank(),
      legend.text = element_text(size=12))
length_plot
```

Export plots:

```{r, eval=FALSE}
ggsave(g_plot, file="../figures/fig_gclusters.svg", units="mm", height=90, width=150, device="svg")
ggsave(chabund_plot, file="../figures/fig_chabundclusters.svg", units="mm", height=90, width=150, device="svg")
ggsave(lag_plot, file="../figures/fig_lagclusters.svg", units="mm", height=90, width=150, device="svg")
ggsave(length_plot, file="../figures/fig_lengthclusters.svg", units="mm", height=90, width=150, device="svg")
```

```{r, eval=FALSE}
# Nice names
growth_asv_plot <- growth_asv %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agriculture", "Meadow"),
         start_day = start_day+1) %>% 
  select(Soil, ASV, g, start_day, length, change_abund_corr, Cluster) %>% 
  pivot_longer(cols=c("g", "start_day", "length", "change_abund_corr"), names_to="parameter", values_to="value")

# combine
head(growth_asv_plot)
```


```{r, eval=FALSE}
# isme specifications
g_plot_isme_legend <- growth_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(value), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  facet_wrap(~parameter, nrow=4, scales="free") +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.title = element_text(size=7),
      legend.text = element_text(size=7),
      strip.text = element_blank())
g_plot_isme_legend

g_plot_isme_nolegend <- growth_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(value), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  facet_wrap(~parameter, nrow=4, scales="free") +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.title = element_text(size=7),
      legend.text = element_text(size=7),
      legend.position = "none",
      strip.text = element_blank())
g_plot_isme_nolegend
```

Export plots:

```{r, eval=FALSE}
ggsave(g_plot_isme_legend, file="../figures/fig_growthclusters_isme_legend.svg", units="mm", height=300, width=85, device="svg")
ggsave(g_plot_isme_nolegend, file="../figures/fig_growthclusters_isme_nolegend.svg", units="mm", height=300, width=85, device="svg")
```

### Statistics

Generation time:

```{r}
# Nested linear model
gclust_lm <- lm(log(g) ~ cluster*Soil, data=growth_asv)
hist(resid(gclust_lm)) # normal
plot(predict(gclust_lm), resid(gclust_lm)) # homoskedastic
anova(gclust_lm)
# test term order
gclust_lm <- lm(log(g) ~ Soil*cluster, data=growth_asv)
anova(gclust_lm) # same

# Contrasts of interest
gclust12_lm <- lm(log(g) ~ cluster, data=filter(growth_asv, cluster %in% c("1", "2")))
hist(resid(gclust12_lm)) # normal
plot(predict(gclust12_lm), resid(gclust12_lm)) # homoskedasticish

gclust23_lm <- lm(log(g) ~ cluster, data=filter(growth_asv, cluster %in% c("2", "3")))
hist(resid(gclust23_lm)) # normal
plot(predict(gclust23_lm), resid(gclust23_lm)) # homoskedastic

gclust13_lm <- lm(log(g) ~ cluster, data=filter(growth_asv, cluster %in% c("1", "3")))
hist(resid(gclust23_lm)) # normal
plot(predict(gclust23_lm), resid(gclust23_lm)) # homoskedasticish

# P adjustment
p.adjust(p=c(summary(gclust12_lm)$coefficients[2,4], summary(gclust23_lm)$coefficients[2,4], summary(gclust13_lm)$coefficients[2,4]),
         method="holm", n=6)
```

Lag:

```{r}
# nested linear model
lagclust_lm <- lm(log(start_day+1) ~ cluster*Soil, data=growth_asv)
hist(resid(lagclust_lm)) # normal
plot(predict(lagclust_lm), resid(lagclust_lm)) # homoskedastic
anova(lagclust_lm)
# Check effect of term order
lagclust_lm <- lm(log(start_day+1) ~ Soil*cluster, data=growth_asv)
anova(lagclust_lm)
# main effects significant in both, will use first nested model

# Contrasts of interest
lagclust12_lm <- lm(log(start_day+1) ~ cluster, data=filter(growth_asv, cluster %in% c("1", "2")))
hist(resid(lagclust12_lm)) # normal
plot(predict(lagclust12_lm), resid(lagclust12_lm)) # homoskedasticish

lagclust23_lm <- lm(log(start_day+1) ~ cluster, data=filter(growth_asv, cluster %in% c("2", "3")))
hist(resid(lagclust23_lm)) # normal
plot(predict(lagclust23_lm), resid(lagclust23_lm)) # homoskedastic

lagclust13_lm <- lm(log(start_day+1) ~ cluster, data=filter(growth_asv, cluster %in% c("1", "3")))
hist(resid(lagclust23_lm)) # normal
plot(predict(lagclust23_lm), resid(lagclust23_lm)) # homoskedastic

lagclust1_lm <- lm(log(start_day+1) ~ Soil, data=filter(growth_asv, cluster %in% c("1")))
hist(resid(lagclust1_lm)) # normalish
plot(predict(lagclust1_lm), resid(lagclust1_lm)) # homoskedasticish

lagclust2_lm <- lm(log(start_day+1) ~ Soil, data=filter(growth_asv, cluster %in% c("2")))
hist(resid(lagclust2_lm)) # normal
plot(predict(lagclust2_lm), resid(lagclust2_lm)) # homoskedastic

lagclust3_lm <- lm(log(start_day+1) ~ Soil, data=filter(growth_asv, cluster %in% c("3")))
hist(resid(lagclust3_lm)) # normal
plot(predict(lagclust3_lm), resid(lagclust3_lm)) # homoskedastic

# P adjustment
p.adjust(p=c(summary(lagclust12_lm)$coefficients[2,4], summary(lagclust23_lm)$coefficients[2,4], summary(lagclust13_lm)$coefficients[2,4],
             summary(lagclust1_lm)$coefficients[2,4], summary(lagclust2_lm)$coefficients[2,4], summary(lagclust3_lm)$coefficients[2,4]),
         method="holm", n=6)
```

Length:

```{r}
# Nested linear model
lengthclust_lm <- lm(log(length) ~ cluster*Soil, data=growth_asv)
hist(resid(lengthclust_lm)) # normalish
plot(predict(lengthclust_lm), resid(lengthclust_lm)) # homoskedasticish
anova(lengthclust_lm)
# check term ordering
lengthclust_lm <- lm(log(length) ~ Soil*cluster, data=growth_asv)
anova(lengthclust_lm) # same

# Contrasts
lengthclust12_lm <- lm(log(length) ~ cluster, data=filter(growth_asv, cluster %in% c("1", "2")))
hist(resid(lengthclust12_lm)) # normal
plot(predict(lengthclust12_lm), resid(lengthclust12_lm)) # homoskedasticish

lengthclust23_lm <- lm(log(length) ~ cluster, data=filter(growth_asv, cluster %in% c("2", "3")))
hist(resid(lengthclust23_lm)) # normal
plot(predict(lengthclust23_lm), resid(lengthclust23_lm)) # homoskedastic

lengthclust13_lm <- lm(log(length) ~ cluster, data=filter(growth_asv, cluster %in% c("1", "3")))
hist(resid(lengthclust23_lm)) # normal
plot(predict(lengthclust23_lm), resid(lengthclust23_lm)) # homoskedastic

lengthclust1_lm <- lm(log(length) ~ Soil, data=filter(growth_asv, cluster %in% c("1")))
hist(resid(lengthclust1_lm)) # normalish
plot(predict(lengthclust1_lm), resid(lengthclust1_lm)) # homoskedasticish

lengthclust2_lm <- lm(log(length) ~ Soil, data=filter(growth_asv, cluster %in% c("2")))
hist(resid(lengthclust2_lm)) # normal
plot(predict(lengthclust2_lm), resid(lengthclust2_lm)) # homoskedastic

lengthclust3_lm <- lm(log(length) ~ Soil, data=filter(growth_asv, cluster %in% c("3")))
hist(resid(lengthclust3_lm)) # normalish
plot(predict(lengthclust3_lm), resid(lengthclust3_lm)) # homoskedastic

# P adjustment
p.adjust(p=c(summary(lengthclust1_lm)$coefficients[2,4], summary(lengthclust2_lm)$coefficients[2,4], summary(lengthclust3_lm)$coefficients[2,4],
             summary(lengthclust12_lm)$coefficients[2,4], summary(lengthclust23_lm)$coefficients[2,4], summary(lengthclust13_lm)$coefficients[2,4]),
         method="holm", n=6)
```

Change abundance:

```{r}
# Nested linear model
chabundclust_lm <- lm(log(change_abund_corr) ~ cluster*Soil, data=growth_asv)
hist(resid(chabundclust_lm)) # normal
plot(predict(chabundclust_lm), resid(chabundclust_lm)) # homoskedasticish
anova(chabundclust_lm)
# check term ordering
chabundclust_lm <- lm(log(change_abund_corr) ~ Soil*cluster, data=growth_asv)
anova(chabundclust_lm) # same

# Contrasts
chabundclust12_lm <- lm(log(change_abund_corr) ~ cluster, data=filter(growth_asv, cluster %in% c("1", "2")))
hist(resid(chabundclust12_lm)) # normal
plot(predict(chabundclust12_lm), resid(chabundclust12_lm)) # homoskedasticish

chabundclust23_lm <- lm(log(change_abund_corr) ~ cluster, data=filter(growth_asv, cluster %in% c("2", "3")))
hist(resid(chabundclust23_lm)) # normal
plot(predict(chabundclust23_lm), resid(chabundclust23_lm)) # homoskedastic

chabundclust13_lm <- lm(change_abund_corr ~ cluster, data=filter(growth_asv, cluster %in% c("1", "3")))
hist(resid(chabundclust23_lm)) # normal
plot(predict(chabundclust23_lm), resid(chabundclust23_lm)) # homoskedastic

chabundclust1_lm <- lm(log(change_abund_corr) ~ Soil, data=filter(growth_asv, cluster %in% c("1")))
hist(resid(chabundclust1_lm)) # normalish
plot(predict(chabundclust1_lm), resid(chabundclust1_lm)) # homoskedastic

chabundclust2_lm <- lm(log(change_abund_corr) ~ Soil, data=filter(growth_asv, cluster %in% c("2")))
hist(resid(chabundclust2_lm)) # normal
plot(predict(chabundclust2_lm), resid(chabundclust2_lm)) # homoskedastic

chabundclust3_lm <- lm(log(change_abund_corr) ~ Soil, data=filter(growth_asv, cluster %in% c("3")))
hist(resid(chabundclust3_lm)) # normalish
plot(predict(chabundclust3_lm), resid(chabundclust3_lm)) # homoskedasticish

# p adjustment
p.adjust(p=c(summary(chabundclust1_lm)$coefficients[2,4], summary(chabundclust2_lm)$coefficients[2,4], summary(chabundclust3_lm)$coefficients[2,4],
             summary(chabundclust12_lm)$coefficients[2,4], summary(chabundclust23_lm)$coefficients[2,4], summary(chabundclust13_lm)$coefficients[2,4]),
         method="holm", n=6)
```

## Death metrics

Reformat/calculate:

```{r}
# Full data
death2 <- inner_join(death, pap) %>% ## add paprica predictions
  mutate(start_abund_corr = start_abund/n16S, ## correct for 16S copy number
         end_abund_corr = end_abund/n16S,
         change_abund_corr = change_abund/n16S,
         length = end_day-start_day) %>% # calculate length of growth
  select(everything(), -c(label, slope:k, start_pt, end_pt, start_abund:change_abund)) %>% 
  left_join(clust)
death2 <- death2[complete.cases(death2),] # remove unclustered results

# ASV averages
death_asv <- inner_join(death, pap) %>% ## add paprica predictions
  mutate(start_abund_corr = start_abund/n16S, ## correct for 16S copy number
         end_abund_corr = end_abund/n16S,
         change_abund_corr = change_abund/n16S,
         length = end_day-start_day) %>% # calculate length of growth
  select(everything(), -c(label, slope:k, start_pt, end_pt, start_abund:change_abund)) %>% 
  group_by(Soil, ASV) %>% # ASV averages
  summarise_at(vars(h:length), mean, na.rm = TRUE) %>% 
  inner_join(clust) ## add cluster memberships
```

Calculate proportion death after growth:

```{r}
# Proportion died after growth
growth_death <- growth2 %>% 
  left_join(clust) %>% 
  select(Soil, ASV, Replicate, cluster, growth_start = start_day, growth_end = end_day) %>% 
  inner_join(death2) %>% 
  select(Soil, ASV, Replicate, cluster, growth_start, growth_end, death_start = start_day, death_end = end_day) %>% 
  filter(death_start >= growth_end)
growth_death

# Died either before or after death
death_anytime <- growth2 %>% 
  left_join(clust) %>% 
  select(Soil, ASV, Replicate, cluster, growth_start = start_day, growth_end = end_day) %>% 
  inner_join(death2) %>% 
  select(Soil, ASV, Replicate, cluster, growth_start, growth_end, death_start = start_day, death_end = end_day)
death_anytime

# Calculate totals
clust_grew_count <- growth2 %>% 
  group_by(Soil, Replicate, cluster) %>% 
  summarize(grew_count = n())
clust_grew_count

clust_died_count <- growth_death %>% 
  group_by(Soil, Replicate, cluster) %>% 
  summarize(died_count = n())
clust_died_count

clust_diedany_count <- death_anytime %>% 
  group_by(Soil, Replicate, cluster) %>% 
  summarize(died_count = n())
clust_diedany_count

# Combine
clust_grewdied_prop <- clust_grew_count %>% 
  inner_join(clust_died_count) %>% 
  mutate(prop_died = died_count/grew_count)
clust_grewdied_prop

clust_diedany_prop <- clust_grew_count %>% 
  inner_join(clust_diedany_count) %>% 
  mutate(prop_died = died_count/grew_count)
clust_grewdied_prop
```

Visualize:

```{r}
# Death after growth proportion
clust_grewdied_prop %>% 
  ggplot(aes(x=cluster, y=prop_died, fill=Soil, color=cluster)) +
  geom_point(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# Death anytime
clust_diedany_prop %>% 
  ggplot(aes(x=cluster, y=prop_died, fill=Soil, color=cluster)) +
  geom_point(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# Halving time
death_asv %>% 
  ggplot(aes(x=cluster, y=log(h), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# Start day
death_asv %>% 
  ggplot(aes(x=cluster, y=log(start_day+1), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# End day
death_asv %>% 
  ggplot(aes(x=cluster, y=end_day, fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# Length
death_asv %>% 
  ggplot(aes(x=cluster, y=log(length), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# start abund
death_asv %>% 
  ggplot(aes(x=cluster, y=log(abs(start_abund_corr)), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()

# change abund
death_asv %>% 
  ggplot(aes(x=cluster, y=log(abs(change_abund_corr)), fill=Soil, color=cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, alpha=0.5) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()
```

Nice figures:

```{r, eval=FALSE}
# Nice names
death_asv_plot <- death_asv %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agriculture", "Meadow"))

# Death after growth prop
diedprop_plot <- clust_grewdied_prop %>% 
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agriculture", "Meadow")) %>% 
  ggplot(aes(x=Cluster, y=prop_died, fill=Soil, color=Cluster)) +
  geom_jitter(aes(shape=Soil), size=4, width=0.1, height=0) +
    scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=14),
    axis.text = element_text(size=12),
    legend.title = element_text(size=14),
    axis.title.x = element_blank(),
    legend.text = element_text(size=12))
diedprop_plot

# h
h_plot <- death_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(h), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, size=2) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=14),
      axis.text = element_text(size=12),
      legend.title = element_text(size=14),
      axis.title.x = element_blank(),
      legend.text = element_text(size=12))
h_plot

# change abund
chabund_death_plot <- death_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(abs(change_abund_corr)), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=14),
      axis.text = element_text(size=12),
      legend.title = element_text(size=14),
      axis.title.x = element_blank(),
      legend.text = element_text(size=12))
chabund_death_plot
```


```{r, eval=FALSE}
# isme specifications

# Nice names
death_asv_plot <- death_asv %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agriculture", "Meadow"))

# Death after growth prop
diedprop_plot_isme_legend <- clust_grewdied_prop %>% 
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agriculture", "Meadow")) %>% 
  ggplot(aes(x=Cluster, y=prop_died, fill=Soil, color=Cluster)) +
  geom_jitter(aes(shape=Soil), size=2, width=0.1, height=0) +
    scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=7),
    axis.text = element_text(size=7),
    legend.title = element_text(size=7),
    axis.title.x = element_blank(),
    legend.text = element_text(size=7))
diedprop_plot_isme_legend

diedprop_plot_isme_nolegend <- clust_grewdied_prop %>% 
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agriculture", "Meadow")) %>% 
  ggplot(aes(x=Cluster, y=prop_died, fill=Soil, color=Cluster)) +
  geom_jitter(aes(shape=Soil), size=2, width=0.1, height=0) +
    scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=7),
    axis.text = element_text(size=7),
    legend.title = element_text(size=7),
    axis.title.x = element_blank(),
    legend.position = "none")
diedprop_plot_isme_nolegend

# h
h_plot_isme_legend <- death_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(h), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, size=2) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.title = element_text(size=7),
      axis.title.x = element_blank(),
      legend.text = element_text(size=7))
h_plot_isme_legend

h_plot_isme_nolegend <- death_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(h), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, size=2) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.title = element_text(size=7),
      axis.title.x = element_blank(),
      legend.position = "none")
h_plot_isme_nolegend

# change abund
chabund_death_plot_isme_nolegend <- death_asv_plot %>% 
  ggplot(aes(x=Cluster, y=log(abs(change_abund_corr)), fill=Soil, color=Cluster)) +
  geom_boxplot() +
  geom_jitter(aes(shape=Soil), height=0, size=2) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.title = element_text(size=7),
      axis.title.x = element_blank(),
      legend.position = "none")
chabund_death_plot_isme_nolegend
```

Export plots:

```{r, eval=FALSE}
ggsave(diedprop_plot_isme_legend, file="../figures/fig_diedprop_isme_legend.svg", units="mm", height=60, width=85, device="svg")
ggsave(diedprop_plot_isme_nolegend, file="../figures/fig_diedprop_isme_nolegend.svg", units="mm", height=60, width=85, device="svg")
ggsave(h_plot_isme_legend, file="../figures/fig_hclusters_isme_legend.svg", units="mm", height=60, width=85, device="svg")
ggsave(h_plot_isme_nolegend, file="../figures/fig_hclusters_isme_nolegend.svg", units="mm", height=60, width=85, device="svg")
ggsave(chabund_death_plot_isme_nolegend, file="../figures/fig_chabunddeathclusters_isme_nolegend.svg", units="mm", height=60, width=85, device="svg")
```

### Statistics

Proportion death after/before growth:

```{r}
# Overall
growthdeath_lm <- lm(log(prop_died) ~ cluster*Soil, data=clust_grewdied_prop) # missing replicates for some soils, so excluding it as effect
hist(resid(growthdeath_lm)) # normalish
plot(predict(growthdeath_lm), resid(growthdeath_lm)) # heteroskedastic
# Switching to welch anova, ignoring soils
growthdeath_wanova <- oneway.test(log(prop_died) ~ cluster, data=clust_diedany_prop, var.equal=FALSE)
growthdeath_wanova
```

Halving times:

```{r}
halfclust_lm <- lm(log(h) ~ cluster*Soil, data=death_asv)
hist(resid(halfclust_lm)) # normalish
plot(predict(halfclust_lm), resid(halfclust_lm)) # homoskedasticish
anova(halfclust_lm)
```

Change in abundance:

```{r}
# Overall
chabundclust_lm <- lm(log(abs(change_abund_corr)) ~ cluster*Soil, data=death_asv)
hist(resid(chabundclust_lm)) # normalish
plot(predict(chabundclust_lm), resid(halfclust_lm)) # homoskedastic
anova(chabundclust_lm)
# Check term order
chabundclust_lm <- lm(log(abs(change_abund_corr)) ~ Soil*cluster, data=death_asv)
anova(chabundclust_lm) # same

# Contrasts
chabundclust12_lm <- lm(log(abs(change_abund_corr)) ~ cluster, data=filter(death_asv, cluster %in% c("1", "2")))
hist(resid(chabundclust12_lm)) # normalish
plot(predict(chabundclust12_lm), resid(chabundclust12_lm)) # homoskedastic

chabundclust23_lm <- lm(log(abs(change_abund_corr)) ~ cluster, data=filter(death_asv, cluster %in% c("2", "3")))
hist(resid(chabundclust23_lm)) # normalish
plot(predict(chabundclust23_lm), resid(chabundclust23_lm)) # heteroskedastic
# Switching to welch t-test...
chabundclust23_welch <- t.test(log(abs(change_abund_corr)) ~ cluster, data=filter(death_asv, cluster %in% c("3", "2")), var.equal=FALSE)

chabundclust13_lm <- lm(log(abs(change_abund_corr)) ~ cluster, data=filter(death_asv, cluster %in% c("1", "3")))
hist(resid(chabundclust23_lm)) # normal
plot(predict(chabundclust23_lm), resid(chabundclust23_lm)) # heteroskedastic
# Switching to welch t-test...
chabundclust13_welch <- t.test(log(abs(change_abund_corr)) ~ cluster, data=filter(death_asv, cluster %in% c("3", "1")), var.equal=FALSE)

chabundclust1_lm <- lm(log(abs(change_abund_corr)) ~ Soil, data=filter(death_asv, cluster %in% c("1")))
hist(resid(chabundclust1_lm)) # normalish
plot(predict(chabundclust1_lm), resid(chabundclust1_lm)) # homoskedastic

chabundclust2_lm <- lm(log(abs(change_abund_corr)) ~ Soil, data=filter(death_asv, cluster %in% c("2")))
hist(resid(chabundclust2_lm)) # normal
plot(predict(chabundclust2_lm), resid(chabundclust2_lm)) # homoskedastic

chabundclust3_lm <- lm(log(abs(change_abund_corr)) ~ Soil, data=filter(death_asv, cluster %in% c("3")))
hist(resid(chabundclust3_lm)) # normal
plot(predict(chabundclust3_lm), resid(chabundclust3_lm)) # homoskedastic

# P adjustment
p.adjust(p=c(summary(chabundclust1_lm)$coefficients[2,4], summary(chabundclust2_lm)$coefficients[2,4], summary(chabundclust3_lm)$coefficients[2,4],
             summary(chabundclust12_lm)$coefficients[2,4], chabundclust23_welch$p.value, chabundclust13_welch$p.value),
         method="holm", n=6)
```

## Number of substrates

Reformat:

```{r}
# Incorporation profiles
incorp <- incorp %>% 
  right_join(clust) %>% 
  filter(!is.na(cellulose)) # remove ASVs with no BLAST match
```

Calculate:

```{r}
# Reformat
incorp_num <- incorp %>% 
  inner_join(clust) %>% 
  group_by(Soil, cluster, substrate_num) %>% 
  summarize(count=n()) %>% 
  ungroup()
incorp_num

# Calculate substrate number
incorp_num %>% 
  ggplot(aes(x=substrate_num, y=count, fill=Soil, color=cluster)) +
  geom_col(position="dodge") +
  facet_wrap(~cluster) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  theme_test()

# No soil distinction
incorp_num_nosoil <- incorp %>%
  inner_join(clust) %>% 
  select(-Soil) %>% 
  unique() %>% 
  group_by(cluster, substrate_num) %>% 
  summarize(count=n()) %>% 
  ungroup()

incorp_num_nosoil %>% 
  ggplot(aes(x=substrate_num, y=count, fill=cluster)) +
  geom_col(position="dodge") +
  facet_wrap(~cluster) +
  scale_fill_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  theme_test()

incorp_num_nosoil %>% 
  ggplot(aes(x=substrate_num, y=count, fill=cluster)) +
  geom_col(position="dodge", color='black') +
  scale_fill_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  theme_test()
```

Nice figure:

```{r, eval=FALSE}
# Nice names
incorp_num_nice <- incorp_num_nosoil %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"))

# plot
subnum_plot_isme_nolegend <- incorp_num_nice %>% 
  ggplot(aes(x=substrate_num, y=count, fill=Cluster)) +
  geom_col(position="dodge", color='black') +
  scale_fill_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  theme_test() +
  theme(axis.title = element_text(size=7),
        axis.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.position = "none")
subnum_plot_isme_nolegend
```

Export figure:

```{r, eval=FALSE}
ggsave(subnum_plot_isme_nolegend, file="../figures/fig_subnum_isme_nolegend.svg", units="mm", height=50, width=75, device="svg") 
```

### Statistics

```{r}
# Reformat
# Each column should be a cluster, each row a number of substrates
incorpnum_mx <- incorp_num_nosoil %>%
  select(cluster, substrate_num, count) %>% 
  pivot_wider(names_from=cluster, values_from=count) %>% 
  column_to_rownames(var="substrate_num") %>% 
  as.matrix()

incorpnum_mx # many cells below 20
rowSums(incorpnum_mx) # fairly high variability
colSums(incorpnum_mx) # fairly high variability

# Fisher exact tests
# Contrasts
incorpnum12_fish <- fisher.test(incorpnum_mx[,1:2], simulate.p.value = TRUE, B = 1e6) # cluster 1 vs 2
incorpnum13_fish <- fisher.test(incorpnum_mx[,c(1,3)], simulate.p.value = TRUE, B = 1e6) # cluster 1 vs 3
incorpnum23_fish <- fisher.test(incorpnum_mx[,2:3], simulate.p.value = TRUE, B = 1e6) # cluster 2 vs 3
# Multiple test adjustment
p.adjust(p=c(incorpnum12_fish$p.value, incorpnum13_fish$p.value, incorpnum23_fish$p.value), method="holm", n=3)
```

## Substrate preference

```{r}
# Reformat
incorp_long <- incorp %>% 
  inner_join(clust) %>% 
  pivot_longer(cellulose:xylose, names_to="substrate", values_to="labelled") %>% 
  pivot_longer(cellulose_firstday:xylose_firstday, names_to="dummy", values_to="first_day") %>% 
  filter(!is.na(first_day)) %>% 
  select(-dummy, -substrate_num,)
incorp_long

incorp_pref <- incorp_long %>% 
  filter(labelled=="yes") %>% 
  group_by(Soil, cluster, substrate) %>% 
  summarize(count = n()) %>% 
  ungroup()
incorp_pref

incorp_pref_nosoil <- incorp_long %>% 
  select(-Soil) %>% 
  unique() %>% 
  filter(labelled=="yes") %>% 
  group_by(cluster, substrate) %>% 
  summarize(count = n()) %>% 
  ungroup()
incorp_pref_nosoil
```

Visualize:

```{r}
incorp_pref %>% 
  ggplot(aes(x=substrate, y=count, color=cluster, fill=Soil)) +
  geom_col(position="dodge") +
  facet_wrap(~cluster) +
  scale_fill_manual(values=c("white", "gray")) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  theme_test()

incorp_pref_nosoil %>% 
  ggplot(aes(x=substrate, y=count, fill=cluster)) +
  geom_col(position="dodge") +
  facet_wrap(~cluster) +
  scale_fill_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  theme_test() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Nice figures:

```{r, eval=FALSE}
# Nice names
incorp_pref_nice <- incorp_pref_nosoil %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         substrate = gsub("_", " ", substrate))


# Substrate preference
subpref_plot_isme_legend <- incorp_pref_nice %>% 
  ggplot(aes(x=reorder(substrate, -count), y=count, fill=Cluster)) +
  geom_col(position="dodge", color='black') +
  scale_fill_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  theme_test() +
  theme(axis.title = element_text(size=7),
        axis.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.text = element_text(size=7))
subpref_plot_isme_legend

subpref_plot_isme_nolegend <- incorp_pref_nice %>% 
  ggplot(aes(x=reorder(substrate, -count), y=count, fill=Cluster)) +
  geom_col(position="dodge", color='black') +
  scale_fill_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  theme_test() +
  theme(axis.title = element_text(size=7),
        axis.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.position = "none")
subpref_plot_isme_nolegend
```

Export plot:

```{r, eval=FALSE}
ggsave(subpref_plot_isme_legend, file="../figures/fig_subpref_isme_legend.svg", units="mm", height=50, width=75, device="svg")
ggsave(subpref_plot_isme_nolegend, file="../figures/fig_subpref_isme_nolegend.svg", units="mm", height=50, width=75, device="svg")
```

### Statistics

```{r}
# Reformat
# Each column should be a cluster, each row a number of substrates
incorppref_mx <- incorp_pref_nosoil %>%
  select(cluster, substrate, count) %>% 
  pivot_wider(names_from=cluster, values_from=count) %>% 
  column_to_rownames(var="substrate") %>% 
  as.matrix()

incorppref_mx # large cell values
rowSums(incorppref_mx) # fairly high variability
colSums(incorppref_mx) # very high variability

# Fisher exact tests
# Contrasts
incorppref12_fish <- fisher.test(incorppref_mx[,1:2], simulate.p.value = TRUE, B = 1e6) # cluster 1 vs 2
incorppref13_fish <- fisher.test(incorppref_mx[,c(1,3)], simulate.p.value = TRUE, B = 1e6) # cluster 1 vs 3
incorppref23_fish <- fisher.test(incorppref_mx[,2:3], simulate.p.value = TRUE, B = 1e6) # cluster 2 vs 3
# Multiple test adjustment
p.adjust(p=c(incorppref12_fish$p.value, incorppref13_fish$p.value, incorppref23_fish$p.value), method="holm", n=3)
```

## Memberships

```{r}
# Taxonomy
tax <- tax %>% inner_join(clust) %>% 
  unique()

# Phyla counts
tax_clust <- tax %>% 
  group_by(Phylum, Soil, cluster) %>% 
  summarize(count = n()) %>% 
  arrange(cluster, -count)

# Visualize
tax_clust %>% 
  ggplot(aes(x=reorder(Phylum, -count), y=count, fill=cluster)) +
  scale_fill_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  #scale_fill_manual(values=c("white", "grey")) +
  geom_col(position="dodge") +
  facet_wrap(~cluster) +
  theme_test() +
  theme(axis.text.x = element_text(angle=45, hjust=1))

tax_clust %>% 
  filter(cluster %in% c("2", "3")) %>% 
  ggplot(aes(x=reorder(Phylum, -count), y=count, color=cluster, fill=Soil)) +
  scale_color_manual(values=c("#929644", "#9473c4")) +
  scale_fill_manual(values=c("white", "grey")) +
  geom_col(position="dodge") +
  facet_wrap(~cluster) +
  theme_test() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Nice figure:

```{r, eval=FALSE}
phylo_plot <- tax_clust %>% 
  mutate(Cluster = case_when(cluster == "1" ~ "Competitor",
                             cluster == "2" ~ "Scarcity",
                             cluster == "3" ~ "Ruderal"),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"),
         Soil = if_else(Soil=="Ag", "Agricultural", "Meadow")) %>% 
  ggplot(aes(x=reorder(Phylum, -count), y=count, color=Cluster, fill=Soil)) +
  geom_col() +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_fill_manual(values=c("white", "grey")) +
  facet_wrap(Cluster~Soil, nrow=3) +
  theme_test() +
  theme(axis.title = element_text(size=14),
    axis.text = element_text(size=10),
    axis.text.x = element_text(angle=45, hjust=1, size=8),
    legend.title = element_text(size=14),
    strip.background = element_blank(),
    strip.text = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none")
phylo_plot
```

Export:

```{r, eval=FALSE}
ggsave(phylo_plot, file="../figures/suppfig_phylomemb.svg", units="mm", height=90, width=120, device="svg")
```

# Cluster representation

## Total abundances

Reformat:

```{r}
# Normalized abundances
abund2 <- abund %>% 
  mutate(ASV = gsub("Ag[1-3]_|Meadow[1-3]_(.+)", "\\1", label)) %>% 
  inner_join(pap) %>% ## add paprica predictions
  filter(Isotope=="12C") %>% 
  select(Soil, Replicate, ASV, Day, norm_abund, n16S) %>% 
  mutate(norm_abund_corr = norm_abund/n16S) %>% ## correct for 16S copy number
  select(everything(), -c(norm_abund, n16S)) %>% 
  inner_join(clust) ## add cluster memberships
```

Calculate:

```{r}
# Calculate cluster totals
abund_total <- abund2 %>% 
  group_by(Soil, Day, Replicate, cluster) %>% 
  summarize(cluster_total = sum(norm_abund_corr)) %>% 
  ungroup()
abund_total

# Calculate total abundance averaged over time
abund_total_avg <- abund_total %>% 
  group_by(Soil, Replicate, cluster) %>% 
  summarize(cluster_total = mean(cluster_total)) %>% 
  ungroup()
abund_total_avg

# over time
abund_total0 <- abund_total %>%
  filter(Day==0)
abund_total0
```

Visualize:

```{r}
# Total abundances
abund_total %>% 
  ggplot(aes(x=Day, y=log(cluster_total), color=cluster)) +
  geom_point() +
  geom_smooth(aes(color=cluster)) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  facet_wrap(~Soil) +
  theme_test()

abund_total_avg %>% 
  ggplot(aes(x=Soil, y=log(cluster_total), color=cluster)) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  geom_jitter(height=0, width=0.1) +
  theme_test()

abund_total0 %>% 
  ggplot(aes(x=Soil, y=log(cluster_total), color=cluster)) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  geom_point() +
  theme_test()
```

Nice figure:

```{r, eval=FALSE}
# Nice names
abund_total0_nice <- abund_total0 %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"))

# Plots
abundtotal0_isme_legend <- abund_total0_nice %>% 
  ggplot(aes(x=Soil, y=log(cluster_total), color=Cluster, shape=Cluster)) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  geom_jitter(height=0, width=0.1, size=3) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.title = element_text(size=7),
      axis.title.x = element_blank(),
      legend.text = element_text(size=7))
abundtotal0_isme_legend

abundtotal0_isme_nolegend <- abund_total0_nice %>% 
  ggplot(aes(x=Soil, y=log(cluster_total), color=Cluster, shape=Cluster)) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  geom_jitter(height=0, width=0.1, size=3) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.title = element_text(size=7),
      axis.title.x = element_blank(),
      legend.position = "none")
abundtotal0_isme_nolegend
```

Export:

```{r, eval=FALSE}
ggsave(abundtotal0_isme_legend, file="../figures/fig_abundtotal0_isme_legend.svg", units="mm", width=70, height=80, device="svg")
ggsave(abundtotal0_isme_nolegend, file="../figures/fig_abundtotal0_isme_nolegend.svg", units="mm", width=70, height=80, device="svg")
```

### Statistics

```{r}
# Overall
total0_lm <- lm(cluster_total ~ cluster*Soil, data=abund_total0)
hist(resid(total0_lm)) # normalish
plot(predict(total0_lm), resid(total0_lm)) # heteroskedastic
# switch to welch anovas

# Overall
oneway.test(cluster_total ~ cluster, data=abund_total0, var.equal=FALSE)
oneway.test(cluster_total ~ Soil, data=abund_total0, var.equal=FALSE)
```

## Proportional abundances

Calculations:

```{r}
# Calculate overall totals
abund_overall <- abund_total %>% 
  group_by(Soil, Day, Replicate) %>% 
  summarize(overall_total = sum(cluster_total)) %>% 
  ungroup()
abund_overall

# Calculate proportions
# By day
abund_prop_day <- abund_total %>% 
  left_join(abund_overall) %>% 
  mutate(prop = cluster_total/overall_total)
abund_prop_day

# Day 0, 15, 30
abund_prop0 <- abund_total %>% 
  filter(Day %in% c(0)) %>% 
  left_join(abund_overall) %>% 
  mutate(prop = cluster_total/overall_total)
abund_prop0

# Averaged across time
abund_overall_avg <- abund_overall %>% 
  group_by(Soil, Replicate) %>% 
  summarize(overall_total = mean(overall_total)) %>% 
  ungroup()
abund_overall_avg

abund_prop_avg <- abund_total %>% 
  left_join(abund_overall_avg) %>% 
  group_by(Soil, Replicate, cluster) %>% 
  summarize(cluster_total = mean(cluster_total), # average across time
            overall_total = mean(overall_total)) %>% 
  mutate(prop = cluster_total/overall_total)
abund_prop_avg
```

Visualize:

```{r}
# over time
abund_prop_day %>%  
  ggplot(aes(x=Day, y=prop, color=cluster)) +
  geom_jitter(width=0.1, height=0) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  facet_wrap(~Soil) +
  geom_smooth(linetype=2) +
  theme_test()

# day 0
abund_prop0 %>%  
  ggplot(aes(x=Soil, y=prop, color=cluster)) +
  geom_jitter(width=0.1, height=0) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  geom_smooth(linetype=2) +
  theme_test()

# avg
abund_prop_avg %>% 
  ggplot(aes(x=Soil, y=prop, color=cluster)) +
  geom_jitter(width=0.1, height=0) +
  scale_color_manual(values=c("#c75d65", "#929644", "#9473c4")) +
  theme_test()
```

Nice figure:

```{r, eval=FALSE}
# Nice names
abund_prop0_nice <- abund_prop0 %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"))

prop0_plot_isme_nolegend <- abund_prop0_nice %>% 
  ggplot(aes(x=Soil, y=prop, color=Cluster, shape=Cluster)) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  geom_jitter(height=0, width=0.1, size=2) +
  theme_test() +
  theme(axis.title = element_text(size=7),
      axis.text = element_text(size=7),
      legend.position = "none")
prop0_plot_isme_nolegend
```

Export:

```{r, eval=FALSE}
ggsave(prop0_plot_isme_nolegend, file="../figures/fig_abundprop0_isme_nolegend.svg", units="mm", width=55, height=60, device="svg")
```

### Statistics

Proportion day 0:

```{r}
prop0_lm <- lm(prop ~ cluster*Soil, data=abund_prop0)
hist(resid(prop0_lm)) # normalish
plot(predict(prop0_lm), resid(prop0_lm)) # heteroskedastic
# Switching to welch tests, interested in differences between soils
prop1_welch <- t.test(prop ~ Soil, data=filter(abund_prop0, cluster=="1"), var.equal=FALSE)
prop2_welch <- t.test(prop ~ Soil, data=filter(abund_prop0, cluster=="2"), var.equal=FALSE)
prop3_welch <- t.test(prop ~ Soil, data=filter(abund_prop0, cluster=="3"), var.equal=FALSE)

# P adjustment
p.adjust(p=c(prop1_welch$p.value, prop2_welch$p.value, prop3_welch$p.value), method="holm", n=4)
```

## Richness

```{r}
# Count clustered taxa at tp0 of each soil
rich_clust <- abund2 %>% 
  filter(Day==0) %>% 
  inner_join(growth2) %>% 
  group_by(Soil, Replicate, cluster) %>% 
  summarize(richness = n()) %>% 
  ungroup()

rich_clust %>% 
  ggplot(aes(x=Soil, y=richness, color=cluster)) +
  geom_jitter(height=0, width=0.1) +
  theme_test()
```

Nice figure:

```{r, eval=FALSE}
# Nice names
rich_nice <- rich_clust %>%
  mutate(Cluster = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         Cluster = as_factor(Cluster),
         Cluster = fct_relevel(Cluster, "Competitor", "Scarcity", "Ruderal"))

rich_plot <- rich_nice %>% 
  ggplot(aes(x=Soil, y=richness, color=Cluster, shape=Cluster)) +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  geom_jitter(height=0, width=0.2, size=2) +
  theme_test() +
  theme(axis.title = element_text(size=14),
      axis.text = element_text(size=12),
      legend.title = element_text(size=14),
      axis.title.x = element_blank(),
      legend.text = element_text(size=12))
rich_plot
```

Export:

```{r, eval=FALSE}
ggsave(rich_plot, file="../figures/fig_rich0.svg", units="mm", width=180, height=90, device="svg")
```

### Statistics

```{r}
rich_lm <- lm(log(richness) ~ cluster*Soil, data=rich_clust)
hist(resid(rich_lm)) # normalish
plot(predict(rich_lm), resid(rich_lm)) # heteroskedastic
# Switching to welch tests, interested in differences between soils
rich1_welch <- t.test(log(richness) ~ Soil, data=filter(rich_clust, cluster=="1"), var.equal=FALSE)
rich2_welch <- t.test(log(richness) ~ Soil, data=filter(rich_clust, cluster=="2"), var.equal=FALSE)
rich3_welch <- t.test(log(richness) ~ Soil, data=filter(rich_clust, cluster=="3"), var.equal=FALSE)
richclust_welch <- oneway.test(log(richness) ~ cluster, data=filter(rich_clust), var.equal=FALSE)

# P adjustment
p.adjust(p=c(rich1_welch$p.value, rich2_welch$p.value, rich3_welch$p.value, richclust_welch$p.value), method="holm", n=4)
```

# Ratio parameters

## R:C

```{r}
# Calculate ratio
rc_param <- abund_total %>% 
  filter(cluster %in% c("3", "1")) %>%
  pivot_wider(id_cols=c(Soil, Day, Replicate), names_from = cluster, values_from = cluster_total) %>% 
  mutate(rc = `3`/`1`)
rc_param

# Average across time
rc_param_avg <- rc_param %>% 
  group_by(Soil, Replicate) %>% 
  summarize(rc = mean(rc)) %>% 
  ungroup()
rc_param_avg
```

Visualize:

```{r}
rc_param %>% 
  ggplot(aes(x=Day, y=rc, color=Soil)) +
  geom_point() +
  geom_smooth() +
  theme_test()

rc_param_avg %>%
  ggplot(aes(x=Soil, y=rc, color=Soil)) +
  geom_point() +
  theme_test()
```

## R:S

```{r}
# Calculate ratio
rs_param <- abund_total %>% 
  filter(cluster %in% c("3", "2")) %>%
  pivot_wider(id_cols=c(Soil, Day, Replicate), names_from = cluster, values_from = cluster_total) %>% 
  mutate(rs = `3`/`2`)
rs_param

# Average across time
rs_param_avg <- rs_param %>% 
  group_by(Soil, Replicate) %>% 
  summarize(rs = mean(rs)) %>% 
  ungroup()
rs_param_avg
```

Visualize:

```{r}
rs_param %>% 
  ggplot(aes(x=Day, y=rs, color=Soil)) +
  geom_point() +
  geom_smooth() +
  theme_test()

rs_param_avg %>%
  ggplot(aes(x=Soil, y=rs, color=Soil)) +
  geom_point() +
  theme_test()
```

## C:S

```{r}
# Calculate ratio
cs_param <- abund_total %>% 
  filter(cluster %in% c("1", "2")) %>%
  pivot_wider(id_cols=c(Soil, Day, Replicate), names_from = cluster, values_from = cluster_total) %>% 
  mutate(cs = `1`/`2`)
cs_param

# Average across time
cs_param_avg <- cs_param %>% 
  group_by(Soil, Replicate) %>% 
  summarize(cs = mean(cs)) %>% 
  ungroup()
cs_param_avg
```

Visualize:

```{r}
cs_param %>% 
  ggplot(aes(x=Day, y=cs, color=Soil)) +
  geom_point() +
  geom_smooth() +
  theme_test()

cs_param_avg %>%
  ggplot(aes(x=Soil, y=cs, color=Soil)) +
  geom_point() +
  theme_test()
```

# Clusters vs carbon

```{r}
# Combine parameters and explore
params_avg <- rc_param %>% 
  inner_join(rs_param) %>% 
  inner_join(cs_param) %>% 
  mutate(c_abund = `1`,
         s_abund = `2`,
         r_abund = `3`,
         c = `1`/(`1`+`2`+`3`),
         s = `2`/(`1`+`2`+`3`),
         r = `3`/(`1`+`2`+`3`),
         r_cs = `3`/(`1`+`2`),
         rc_s = (`1` + `3`)/`2`) %>%  # adding one I think might be interesting based on future knowledge of results below
  select(Soil:Replicate, c_abund, s_abund, r_abund, c, s, r, rc, rs, cs, r_cs, rc_s) %>% 
  group_by(Soil, Day) %>% 
  summarize_if(is.numeric, mean, na.rm=TRUE) %>% 
  ungroup()

# Growth eff.
greff_avg <- greff %>% 
  group_by(Soil, Day) %>% 
  summarize(greff = mean(greff)) %>% 
  ungroup()

# Calaculate respiration rates
# Time (days) elapsed per time point
time_steps <- data.frame(time_step = c(0, rep(1, 11), rep(2, 8), 3),
                         Day = sort(unique(resp$Day)))

resprate <- resp %>%
  mutate(Replicate= case_when(Microcosm %in% c(185, 188, 191) ~ 1, # add replicates
                              Microcosm %in% c(186, 189, 192) ~ 2,
                              Microcosm %in% c(187, 190, 193) ~ 3)) %>%
  filter(Litter=="litter") %>% # remove samples without litter added
  select(Soil, Day, Replicate, Measurement, mg_co2) %>%
  pivot_wider(id_cols=c(Soil, Day, Replicate), names_from=Measurement, values_from=mg_co2) %>% 
  drop_na() %>% 
  inner_join(time_steps) %>% 
  mutate(mgCO2 = mz44 + mz45,
         mgCO2_day = mgCO2/time_step) %>% 
  select(Soil, Day, Replicate, mgCO2, mgCO2_day)
resprate

# Combine all
params_greffresp <- params_avg %>% 
  inner_join(greff_avg) %>% 
  inner_join(resprate)
params_greffresp
```

## Visualize

### Growth efficiency

Individual:

```{r}
params_greffresp %>% 
  ggplot(aes(x=c_abund, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=r_abund, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=s_abund, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=c, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=s, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=r, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
```

Ratios:

```{r}
params_greffresp %>% 
  ggplot(aes(x=rc, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
  
params_greffresp %>% 
  ggplot(aes(x=cs, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
  
params_greffresp %>% 
  ggplot(aes(x=rs, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=r_cs, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=rc_s, y=greff)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
```

Nice figure:

```{r, eval=FALSE}
rcsgreff_plot <- params_greffresp %>% 
  mutate(Soil = if_else(Soil=="Ag", "Agricultural", "Meadow")) %>% 
  ggplot(aes(x=r_cs, y=log(greff))) +
  geom_point(aes(shape=Soil), size=2) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(aes(group=Soil, linetype=Soil), method="lm", color="black") +
  scale_linetype_manual(values=c("dashed", "solid")) +
  theme_test() +
  theme(axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    legend.position = "none")
rcsgreff_plot
```

Nice figures:

```{r, eval=FALSE}
ggsave(rcsgreff_plot, file="../figures/fig_rcsgreff.svg", units="mm", height=70, width=80, device="svg")
```

#### Statistics

```{r}
rcsgreff_avg <- params_greffresp %>% 
  group_by(Soil, Day) %>% 
  summarize(greff = mean(greff),
            mgco2_day = mean(mgCO2_day),
            r_cs = mean(r_cs)) %>% 
  ungroup()

# Overall
cor.test(rcsgreff_avg$r_cs, log(rcsgreff_avg$greff))
# Soils
cor.test(rcsgreff_avg[rcsgreff_avg$Soil=="Ag",]$r_cs, log(rcsgreff_avg[rcsgreff_avg$Soil=="Ag",]$greff))
cor.test(rcsgreff_avg[rcsgreff_avg$Soil=="Meadow",]$r_cs, log(rcsgreff_avg[rcsgreff_avg$Soil=="Meadow",]$greff))
```

```{r}
csgreff_avg <- params_greffresp %>% 
  group_by(Soil, Day) %>% 
  summarize(greff = mean(greff),
            mgco2_day = mean(mgCO2_day),
            cs = mean(cs)) %>% 
  ungroup()

# Overall
cor.test(csgreff_avg$cs, log(csgreff_avg$greff))
# Soils
cor.test(csgreff_avg[csgreff_avg$Soil=="Ag",]$cs, log(csgreff_avg[csgreff_avg$Soil=="Ag",]$greff))
cor.test(csgreff_avg[csgreff_avg$Soil=="Meadow",]$cs, log(csgreff_avg[csgreff_avg$Soil=="Meadow",]$greff))
```


### Respiration rate

Individual:

```{r}
params_greffresp %>% 
  ggplot(aes(x=c_abund, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", linetype=3) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=s_abund, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", linetype=3) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=r_abund, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", linetype=3) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=c, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", linetype=3) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=s, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", linetype=3) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=r, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", linetype=3) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
```

Combos:

```{r}
params_greffresp %>% 
  ggplot(aes(x=rc, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
  
params_greffresp %>% 
  ggplot(aes(x=cs, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
  
params_greffresp %>% 
  ggplot(aes(x=rs, y=mgCO2_day)) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=r_cs, y=log(mgCO2_day))) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()

params_greffresp %>% 
  ggplot(aes(x=rc_s, y=log(mgCO2_day))) +
  geom_point(aes(shape=Soil)) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(method="lm", color="black", aes(linetype=Soil)) +
  theme_test()
```

Nice figure:

```{r, eval=FALSE}
rcsresp_plot <- params_greffresp %>% 
  mutate(Soil = if_else(Soil=="Ag", "Agricultural", "Meadow")) %>% 
  ggplot(aes(x=r_cs, y=mgCO2_day)) +
  geom_point(aes(shape=Soil), size=2) +
  scale_shape_manual(values=c(1,16)) +
  geom_smooth(aes(group=Soil, linetype=Soil), method="lm", color="black", alpha=0.3) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  theme_test() +
  theme(axis.title = element_text(size=12),
      axis.text = element_text(size=10),
      legend.position = "none")
rcsresp_plot
```

Export:

```{r, eval=FALSE}
ggsave(rcsresp_plot, file="../figures/fig_rcsresp.svg", units="mm", height=70, width=80, device="svg")
```

#### Statistics

```{r}
rcsgreff_avg

# overall
cor.test(rcsgreff_avg$r_cs, rcsgreff_avg$mgco2_day)

# sep soils
cor.test(rcsgreff_avg[rcsgreff_avg$Soil=="Ag",]$r_cs, rcsgreff_avg[rcsgreff_avg$Soil=="Ag",]$mgco2_day)
cor.test(rcsgreff_avg[rcsgreff_avg$Soil=="Meadow",]$r_cs, rcsgreff_avg[rcsgreff_avg$Soil=="Meadow",]$mgco2_day)
```

```{r}
csgreff_avg

# overall
cor.test(csgreff_avg$cs, csgreff_avg$mgco2_day)

# sep soils
cor.test(csgreff_avg[csgreff_avg$Soil=="Ag",]$cs, csgreff_avg[csgreff_avg$Soil=="Ag",]$mgco2_day)
cor.test(csgreff_avg[csgreff_avg$Soil=="Meadow",]$cs, csgreff_avg[csgreff_avg$Soil=="Meadow",]$mgco2_day)
```


# Net cluster changes

Calculate:

```{r}
net_clust <- abund_total %>% 
  filter(Day %in% c(0, 10, 21, 30)) %>% 
  pivot_wider(id_cols=c(Soil, Replicate, cluster), names_from=Day, values_from=cluster_total) %>% 
  mutate(net010 = `10`-`0`,
         net021 = `21`-`0`,
         net030 = `30`-`0`) %>% 
  select(Soil, Replicate, cluster, net010, net021, net030) %>% 
  pivot_longer(c(net010, net021, net030), names_to="time_diff", values_to="net_change")
net_clust
```

Visualize:

```{r}
net_clust %>% 
  mutate(cluster = case_when(cluster=="1" ~ "competitor",
                             cluster=="2" ~ "scarcity",
                             cluster=="3" ~ "ruderal"),
         cluster = fct_relevel(cluster, "competitor", "scarcity", "ruderal")) %>% 
  ggplot(aes(x=time_diff, y=net_change, shape=Soil, color=cluster)) +
  geom_jitter(height=0, width=0.1) +
  geom_hline(yintercept=0, linetype=2, color="gray") +
  scale_color_manual(values=c("#9473c4", "#929644", "#c75d65")) +
  scale_shape_manual(values=c(1,16)) +
  theme_test()
```

### Statistics

```{r}
# 0 - 10
net010_lm <- lm(net_change ~ cluster, data=filter(net_clust, time_diff=="net010"))
hist(resid(net010_lm)) # normalish
plot(predict(net010_lm), resid(net010_lm)) # heteroskedastic
# swtich to welch
oneway.test(net_change ~ cluster, data=net_clust, var.equal=FALSE)
# Contrasts
net010_cs_welch <- t.test(net_change ~ cluster, data=filter(net_clust, time_diff=="net010" & cluster %in% c("1", "2")), var.equal=FALSE)
net010_cr_welch <- t.test(net_change ~ cluster, data=filter(net_clust, time_diff=="net010" & cluster %in% c("1", "3")), var.equal=FALSE)
net010_rs_welch <- t.test(net_change ~ cluster, data=filter(net_clust, time_diff=="net010" & cluster %in% c("3", "2")), var.equal=FALSE)
# p-adjustment
p.adjust(p=c(net010_cs_welch$p.value, net010_cr_welch$p.value, net010_rs_welch$p.value),
         method="holm", n=3)

# 0 - 21
net021_lm <- lm(net_change ~ cluster, data=filter(net_clust, time_diff=="net021"))
hist(resid(net021_lm)) # normalish
plot(predict(net010_lm), resid(net010_lm)) # heteroskedastic
# swtich to welch
oneway.test(net_change ~ cluster, data=filter(net_clust, time_diff=="net021"), var.equal=FALSE)

# 0 - 30
net030_lm <- lm(net_change ~ cluster, data=filter(net_clust, time_diff=="net030"))
hist(resid(net021_lm)) # normalish
plot(predict(net010_lm), resid(net010_lm)) # heteroskedastic
# swtich to welch
oneway.test(net_change ~ cluster, data=filter(net_clust, time_diff=="net030"), var.equal=FALSE)
```

# Clusters per time point

```{r}
head(abund_total)
abund_time_plot <- abund_total %>% 
  mutate(cluster_name = case_when(cluster=="1" ~ "Competitor",
                             cluster=="2" ~ "Scarcity",
                             cluster=="3" ~ "Ruderal"),
         cluster_name = as_factor(cluster_name),
         cluster_name = fct_relevel(cluster_name, "Competitor", "Scarcity", "Ruderal")) %>% 
  group_by(Soil, Day, cluster, cluster_name) %>% 
  summarize(cluster_total = mean(cluster_total)) %>% 
  ggplot(aes(x=Day, y=cluster_total, color=cluster_name, shape=cluster_name,)) +
  geom_point(size=2) +
  facet_wrap(~Soil) +
  scale_color_manual(values=c( "#9473c4", "#929644", "#c75d65")) +
  labs(y="total abundance of growing taxa in cluster") +
  theme_test() +
  theme(axis.title = element_text(size=7),
        strip.text = element_blank(),
        axis.text = element_text(size=7),
        legend.position = "none")
abund_time_plot
```

```{r, eval=FALSE}
ggsave(abund_time_plot, file="../figures/fig_abundclust_time.svg", unit="mm", width=110, height=60)
```

