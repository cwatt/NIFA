---
title: "NIFA - internal standard"
author: "Cassandra Wattenburger"
date: "9/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Import data

* Counts
* Taxonomy
* Metadata

```{r}
count <- read_tsv("../data_amplicon/NIFA/final/NIFA.counts-final.tsv")
tax <- read_tsv("../data_amplicon/NIFA/final/NIFA.taxonomy-final.tsv")
meta <- read_tsv("../NIFA_metadata.tsv")
```

# Isolate internal standard ASVs

* Aquifex aolicus

```{r}
aqui_asvs <- filter(tax, Genus == "Aquifex") %>% 
  select(ASV)
```

# Calculate proportion Aquifex ASV per sample

```{r}
# Calculate total internal std count per sample
aqui_totals <- count %>%
  filter(ASV %in% aqui_asvs$ASV) %>% 
  column_to_rownames(var="ASV") %>%
  colSums()

# Calculate total reads per sample
sample_totals <- count %>% 
  column_to_rownames("ASV") %>% 
  colSums()

# Combine and calculate proportion aquifex
aqui_perc <- bind_rows(sample_totals, aqui_totals) %>% 
  t() %>% 
  as.data.frame() %>% 
  select(total=V1, aqui=V2) %>% 
  mutate(percent = (aqui/total)*100)

head(aqui_perc)
```

Visualize:

```{r}
aqui_perc %>% 
  rownames_to_column("Sample") %>% 
  ggplot(aes(x=Sample, y=percent)) + 
  geom_point() +
  theme_test()
```

Percent samples with no internal standard:

```{r}
aqui_present <- aqui_perc %>% 
  mutate(present = if_else(percent > 0, "yes", "no")) 

aqui_present %>% 
  group_by(present) %>% 
  summarize(total=n())
```

Average percent overall:

```{r}
aqui_present %>% 
  rownames_to_column("Sample") %>% 
  filter(!(Sample %in% c(197, 198, 199, 200, 201))) %>% # remove negative controls
  summarize(mean = mean(percent),
            min = min(percent),
            max = max(percent),
            sd = sd(percent))
```


Average percent of samples with internal standard:

```{r}
aqui_present %>% 
  rownames_to_column("Sample") %>% 
  filter(present=="yes" & !(Sample %in% c(197, 198, 199, 200, 201))) %>% # remove negative controls and standardless samples
  summarize(mean = mean(percent),
            min = min(percent),
            max = max(percent),
            sd = sd(percent))
```

Average counts of aquifex overall:

```{r}
aqui_present %>% 
  rownames_to_column("Sample") %>% 
  filter(!(Sample %in% c(197, 198, 199, 200, 201))) %>% # remove negative controls
  summarize(count_mean = mean(aqui),
            min = min(percent),
            max = max(percent),
            sd = sd(percent))
```

Average counts of aquifex in samples with internal standard:

```{r}
aqui_present %>% 
  rownames_to_column("Sample") %>% 
  filter(present=="yes" & !(Sample %in% c(197, 198, 199, 200, 201))) %>% # remove negative controls and standardless samples
  summarize(count_mean = mean(aqui),
            min = min(aqui),
            max = max(aqui),
            sd = sd(aqui))
```

# Choose testing samples for internal standar5d recalculation

Import DNA conc. of samples:

```{r}
dna <- read_tsv("../data_picogreen/NIFA_dnaconc.tsv") %>% 
  select(SampleID=ucosm, dna_conc) %>% 
  mutate(SampleID = as.character(SampleID))

# Combine
aqui_dna <- aqui_present %>% 
  rownames_to_column("SampleID") %>% 
  inner_join(dna)
```

Relationship between DNA conc. and percent int. std:

```{r}
aqui_dna %>% 
  ggplot(aes(x=dna_conc, y=percent)) +
  geom_point() +
  theme_test()
```


Choose testing samples:

* 10 samples total
* 5 that had internal std. in current run
* 5 that did not have internal std. in current run
* range between high and low DNA conc. (> or < avg.)

```{r}
avg_dna <- aqui_dna %>% 
  summarize(dna_avg = mean(dna_conc)) %>% 
  as.numeric()

# categories to select from
samples_yesintstd_highdna <- filter(aqui_dna, dna_conc >= avg_dna & present=="yes")
samples_nointstd_highdna <- filter(aqui_dna, dna_conc >= avg_dna & present=="no")
samples_yesintstd_lowdna <- filter(aqui_dna, dna_conc <= avg_dna & present=="yes")
samples_nointstd_lowdna <- filter(aqui_dna, dna_conc <= avg_dna & present=="no")

# randomly select samples for testing
set.seed(10)
sample(samples_yesintstd_highdna$SampleID, size=2)
sample(samples_yesintstd_lowdna$SampleID, size=2)
sample(samples_nointstd_highdna$SampleID, size=2)
sample(samples_nointstd_lowdna$SampleID, size=2)
sample(filter(aqui_dna, present=="yes")$SampleID, size=1)
sample(filter(aqui_dna, present=="no")$SampleID, size=1)
```

