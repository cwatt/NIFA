---
title: "NIFA soil treatment analysis"
author: "Cassandra Wattenburger"
date: "2/17/2023"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

```{r}
# ggplot theme
# See: https://benjaminlouis-stat.fr/en/blog/2020-05-21-astuces-ggplot-rmarkdown/
theme_clean <- function(base_size = 14) {
  theme_test(base_size = base_size) %+replace%
    theme(axis.title = element_text(size=12),
          axis.text = element_text(size=10, color="black"),
          legend.text = element_text(size=10),
          legend.title = element_text(size=10),
          panel.border = element_rect(color="black"))
}
```

# Import data

```{r}
# Growth estimates
growth <- readRDS("../data_intermediate/NIFA_grests_final_ind.rds")

# Death estimates
death <- readRDS("../data_intermediate/NIFA_dests_final_ind.rds")

# Paprica estimates
pap <- readRDS("../data_intermediate/NIFA_paprica_ests.rds")

# Prepped normalized abundnace data
abund <- readRDS("../data_intermediate/NIFA_norm_prepped.rds")

# Taxonomy
tax <- read_tsv("../data_amplicon/NIFA2/final/NIFA2.taxonomy-final.tsv")

# metadata
meta <- read_tsv("../NIFA_metadata.tsv")
```

Reformat data: 

```{r}
# Add paprica estimates
growth2 <- growth %>% 
  left_join(pap)

death2 <- death %>% 
  left_join(pap)

# Combine growth and death estimates
growth_death <- death2 %>%
  rename(g="h") %>% 
  bind_rows(growth2) %>% 
  mutate(type = if_else(slope < 0, "death", "growth"),
         start_abund_corr = start_abund/n16S,
         end_abund_corr = end_abund/n16S,
         change_abund_corr = change_abund/n16S) %>% 
  select(label:end_day, start_abund_corr, end_abund_corr, change_abund_corr, n16S:type)
```

# Diversity overview

## Alpha diversity

After preprocessing, sparcity filtering, and rarefication.

```{r}
# Agricultural ASVs before estimation
abund %>% 
  mutate(ASV = gsub("[a-z]+[1-3]_(.+)", "\\1", label, ignore.case = TRUE)) %>% 
  filter(Soil=="Ag") %>% 
  select(ASV) %>% 
  unique() %>% 
  nrow()

# Meadow
abund %>% 
  mutate(ASV = gsub("[a-z]+[1-3]_(.+)", "\\1", label, ignore.case = TRUE)) %>% 
  filter(Soil=="Meadow") %>% 
  select(ASV) %>% 
  unique() %>% 
  nrow()
```

Total unique ASVs with estimates:

```{r}
# Growth
# Ag
growth_death %>% 
  filter(type=="growth" & Soil=="Ag") %>% 
  select(ASV) %>% 
  unique() %>% 
  nrow()

# Meadow
growth_death %>% 
  filter(type=="growth" & Soil=="Meadow") %>% 
  select(ASV) %>% 
  unique() %>% 
  nrow()

# Death
# Ag
growth_death %>% 
  filter(type=="death" & Soil=="Ag") %>% 
  select(ASV) %>% 
  unique() %>% 
  nrow()

# Meadow
growth_death %>% 
  filter(type=="death" & Soil=="Meadow") %>% 
  select(ASV) %>% 
  unique() %>% 
  nrow()
```

Phyla with most estimated ASVs?

```{r}
# Growth

# Total estimates per phylum per soil
growth_phytots <- growth_death %>% 
  inner_join(tax) %>% 
  filter(type=="growth") %>% 
  select(Soil, Phylum, ASV) %>% 
  unique() %>% 
  group_by(Soil, Phylum) %>% 
  summarize(phy_total = n()) %>% 
  ungroup()

# Total estimates per soil
growth_soiltots <- growth_phytots %>% 
  group_by(Soil) %>%
  summarise(soil_total = sum(phy_total)) %>% 
  ungroup()
  
# Relative proportion of phylum estimates
growth_soilphytots <- growth_phytots %>% 
  full_join(growth_soiltots) %>% 
  mutate(relabund = phy_total/soil_total)

# Visualize
palette_bw2 <- c("white", "darkgrey")

growth_soilphytots %>% 
  ggplot(aes(x=reorder(Phylum, -relabund), y=relabund, fill=Soil)) +
  geom_col(color="black", position = "dodge") +
  labs(y="Relative proportion", title="Proportion of growing ASVs from each phyla per soil") +
  scale_fill_manual(values=palette_bw2) +
  theme_test() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.text = element_text(size=10, color="black"),
        axis.title = element_text(size=12),
        legend.text = element_text(size=10),
        legend.title = element_text(size=10),
        panel.border = element_rect(color="black")
        )

# Death

# Total estimates per phylum per soil
growth_phytots <- growth_death %>% 
  inner_join(tax) %>% 
  filter(type=="death") %>% 
  select(Soil, Phylum, ASV) %>% 
  unique() %>% 
  group_by(Soil, Phylum) %>% 
  summarize(phy_total = n()) %>% 
  ungroup()

# Total estimates per soil
growth_soiltots <- growth_phytots %>% 
  group_by(Soil) %>%
  summarise(soil_total = sum(phy_total)) %>% 
  ungroup()
  
# Relative proportion of phylum estimates
growth_soilphytots <- growth_phytots %>% 
  full_join(growth_soiltots) %>% 
  mutate(relabund = phy_total/soil_total)

# Visualize
growth_soilphytots %>% 
  ggplot(aes(x=reorder(Phylum, -relabund), y=relabund, fill=Soil)) +
  geom_col(color="black", position = "dodge") +
  labs(y="Relative proportion", title="Proportion of dying ASVs from each phyla per soil") +
  scale_fill_manual(values=palette_bw2) +
  theme_test() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.text = element_text(size=10, color="black"),
        axis.title = element_text(size=12),
        legend.text = element_text(size=10),
        legend.title = element_text(size=10),
        panel.border = element_rect(color="black"))
```

## Beta diversity

```{r}
# Import phyloseq object
physeq <- readRDS("../data_intermediate/NIFA_physeq_rare.rds")

# Distance
#phy_dist <- 
```


# Community-level

Growth summary:

```{r}
# Growth

# Average number of estimates
growth_death %>%
  filter(type=="growth") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(ests=n()) %>% 
  ungroup() %>%
  group_by(Soil) %>% 
  summarize(ests_mean = mean(ests),
            ests_sd = sd(ests))

# Average generation time
growth_death %>% 
  filter(type=="growth") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(g = mean(g)) %>% 
  ungroup() %>% 
  group_by(Soil) %>% 
  summarise(g_mean = mean(g),
            g_sd = sd(g))

# Lag time
growth_death %>% 
  filter(type=="growth") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(lag = mean(start_day)) %>% 
  ungroup() %>% 
  group_by(Soil) %>% 
  summarise(lag_mean = mean(lag),
            lag_sd = sd(lag))

# change in abundance
growth_death %>% 
  filter(type=="growth") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(chabund = mean(change_abund_corr, na.rm=TRUE)) %>% 
  ungroup() %>% 
  group_by(Soil) %>% 
  summarise(chabund_mean = mean(chabund),
            chabund_sd = sd(chabund))
```

Death summary:

```{r}
# Death

# Average number of estimates
growth_death %>%
  filter(type=="death") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(ests=n()) %>% 
  ungroup() %>%
  group_by(Soil) %>% 
  summarize(ests_mean = mean(ests),
            ests_sd = sd(ests))

# Average generation time
growth_death %>% 
  filter(type=="death") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(g = mean(g)) %>% 
  ungroup() %>% 
  group_by(Soil) %>% 
  summarise(g_mean = mean(g),
            g_sd = sd(g))

# Lag time
growth_death %>% 
  filter(type=="death") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(lag = mean(start_day)) %>% 
  ungroup() %>% 
  group_by(Soil) %>% 
  summarise(lag_mean = mean(lag),
            lag_sd = sd(lag))

# change in abundance
growth_death %>% 
  filter(type=="death") %>% 
  group_by(Soil, Replicate) %>% 
  summarize(chabund = mean(change_abund_corr, na.rm=TRUE)) %>% 
  ungroup() %>% 
  group_by(Soil) %>% 
  summarise(chabund_mean = mean(chabund),
            chabund_sd = sd(chabund))
```

Visualize:

```{r}
# Average across ASVs per replicate
growth_death_com <- growth_death %>% 
  group_by(Soil, Replicate, type) %>% 
  summarize(k = mean(k),
            g = mean(g),
            start_day = mean(start_day, na.rm=TRUE),
            end_day = mean(end_day, na.rm=TRUE),
            start_abund_corr = mean(start_abund_corr, na.rm=TRUE),
            end_abund_corr = mean(end_abund_corr, na.rm=TRUE),
            change_abund_corr = mean(change_abund_corr, na.rm=TRUE),
            n16S = mean(n16S, na.rm=TRUE),
            genome_size = mean(genome_size, na.rm=TRUE),
            npaths_actual = mean(npaths_actual, na.rm=TRUE),
            nec_actual = mean(nec_actual, na.rm=TRUE)) %>% 
  ungroup()

# Visualize
growth_death_com %>% 
  pivot_longer(cols = -c(Soil, Replicate, type), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x=type, y=abs(value), color=Soil)) +
  geom_jitter(width=0.1) +
  facet_wrap(~variable, scales="free") +
  theme_test()

growth_death_com %>% 
  pivot_longer(cols = -c(Soil, Replicate, type), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x=type, y=log(abs(value)), color=Soil)) +
  geom_jitter(width=0.1) +
  facet_wrap(~variable, scales="free") +
  theme_test()
```

Figure:

```{r}
# Figure
palette_bw2 <- c("black", "white")
growth_death_com %>% 
  select(Soil, Replicate, type, g, start_day, start_abund=start_abund_corr, end_abund=end_abund_corr, change_abund=change_abund_corr, n16S) %>%
  pivot_longer(cols = -c(Soil, Replicate, type), names_to = "variable", values_to = "value") %>%
  mutate(variable = factor(variable, levels=c("start_day", "g", "n16S", "start_abund", "end_abund", "change_abund"))) %>%
  ggplot(aes(x=type, y=log(abs(value)), shape=Soil)) +
  geom_jitter(width=0.1, size=2) +
  facet_wrap(~variable, scales="free") +
  #scale_color_manual(values=palette_bw2) +
  scale_shape_manual(values=c(1,16)) +
  theme_test() +
  theme(axis.title.x = element_blank(),
      axis.text = element_text(size=10, color="black"),
      axis.title = element_text(size=12),
      legend.text = element_text(size=10),
      legend.title = element_text(size=10),
      panel.border = element_rect(color="black"),
      strip.text = element_text(size = 10),
      strip.background = element_blank())
```

## Statistics

Growth:

```{r}
# Change abund
chabund_gr_lm <- lm(change_abund_corr ~ Soil, 
                 data=growth_death_com[growth_death_com$type=="growth",])
hist(resid(chabund_gr_lm))
plot(predict(chabund_gr_lm), resid(chabund_gr_lm))
summary(chabund_gr_lm)

# Start abund
startabund_gr_lm <- lm(log(start_abund_corr) ~ Soil, 
                 data=growth_death_com[growth_death_com$type=="growth",])
hist(resid(startabund_gr_lm))
plot(predict(startabund_gr_lm), resid(startabund_gr_lm))
summary(startabund_gr_lm)

# End abund
endabund_gr_lm <- lm(log(end_abund_corr) ~ Soil, 
                 data=growth_death_com[growth_death_com$type=="growth",])
hist(resid(endabund_gr_lm))
plot(predict(endabund_gr_lm), resid(endabund_gr_lm))
summary(endabund_gr_lm)
```

Death:

```{r}
# Change abund
chabund_de_lm <- lm(log(abs(change_abund_corr)) ~ Soil, 
                 data=growth_death_com[growth_death_com$type=="death",])
hist(resid(chabund_de_lm)) 
plot(predict(chabund_de_lm), resid(chabund_de_lm))
summary(chabund_de_lm)

# Start abund
startabund_de_lm <- lm(log(start_abund_corr) ~ Soil, 
                 data=growth_death_com[growth_death_com$type=="death",])
hist(resid(startabund_de_lm))
plot(predict(startabund_de_lm), resid(startabund_de_lm))
summary(startabund_de_lm)

# End abund
endabund_de_lm <- lm(log(end_abund_corr) ~ Soil, 
                 data=growth_death_com[growth_death_com$type=="death",])
hist(resid(endabund_de_lm))
plot(predict(endabund_de_lm), resid(endabund_de_lm)) # heteroskedastic
## Welch's t-test on log transformed data
t.test(log(end_abund_corr) ~ Soil, 
                 data=growth_death_com[growth_death_com$type=="death",], equal.var=FALSE)
```

# ASV-level

```{r}
# Average across replicates per ASV
growth_death_asv <- growth_death %>% 
  group_by(Soil, ASV, type) %>% 
  summarize(k = mean(k),
            g = mean(g),
            start_day = mean(start_day, na.rm=TRUE),
            end_day = mean(end_day, na.rm=TRUE),
            start_abund_corr = mean(start_abund_corr, na.rm=TRUE),
            end_abund_corr = mean(end_abund_corr, na.rm=TRUE),
            change_abund_corr = mean(change_abund_corr, na.rm=TRUE),
            n16S = mean(n16S, na.rm=TRUE),
            genome_size = mean(genome_size, na.rm=TRUE),
            npaths_actual = mean(npaths_actual, na.rm=TRUE),
            nec_actual = mean(nec_actual, na.rm=TRUE)) %>% 
  ungroup()
```

Visualize:

```{r}
# Visualize
growth_death_asv %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x=type, y=abs(value), color=Soil)) +
  geom_boxplot() +
  facet_wrap(~variable, scales="free") +
  theme_test()

growth_death_asv %>%
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x=type, y=log(abs(value)), color=Soil)) +
  geom_boxplot() +
  facet_wrap(~variable, scales="free") +
  labs(title="Growth - log") +
  theme_test()

# Death traits
growth_death_asv %>% 
  filter(type=="death") %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x=type, y=abs(value), color=Soil)) +
  geom_boxplot() +
  facet_wrap(~variable, scales="free") +
  labs(title="Growth") +
  theme_test()

growth_death_asv %>% 
  filter(type=="death") %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  ggplot(aes(x=type, y=log(abs(value)), color=Soil)) +
  geom_boxplot() +
  facet_wrap(~variable, scales="free") +
  labs(title="Growth - log") +
  theme_test()

# Growth trait density
growth_death_asv %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  filter(type=="growth") %>% 
  ggplot(aes(abs(value), color=Soil)) +
  geom_density() +
  facet_wrap(~variable, scales="free") +
  labs(title="Growth") +
  theme_test()

growth_death_asv %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  filter(type=="growth") %>% 
  ggplot(aes(log(abs(value)), color=Soil)) +
  geom_density() +
  facet_wrap(~variable, scales="free") +
  labs(title="Growth - log") +
  theme_test()

# Death trait density
growth_death_asv %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  filter(type=="death") %>% 
  ggplot(aes(abs(value), color=Soil)) +
  geom_density() +
  facet_wrap(~variable, scales="free") +
  labs(title="Death") +
  theme_test()

growth_death_asv %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  filter(type=="death") %>% 
  ggplot(aes(log(abs(value)), color=Soil)) +
  geom_density() +
  facet_wrap(~variable, scales="free") +
  labs(title="Death - log") +
  theme_test()
```

Figure:

```{r}
# Growth
palette_bw2 <- c("darkgrey", "black")
growth_death_asv %>% 
  filter(type=="growth") %>% 
  select(Soil:type, g, start_day, start_abund=start_abund_corr, end_abund=end_abund_corr, change_abund=change_abund_corr, n16S) %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  mutate(variable = factor(variable, levels=c("start_day", "g", "n16S", "start_abund", "end_abund", "change_abund"))) %>%
  ggplot(aes(log(abs(value)), color=Soil)) +
  geom_density() +
  facet_wrap(~variable, scales="free") +
  scale_color_manual(values=palette_bw2) +
  labs(title="Growth") +
  theme_test() +
  theme(axis.text = element_text(size=10, color="black"),
      axis.title = element_text(size=12),
      legend.text = element_text(size=10),
      legend.title = element_text(size=10),
      panel.border = element_rect(color="black"),
      strip.text = element_text(size = 10),
      strip.background = element_blank())

# Death
palette_bw2 <- c("darkgrey", "black")
growth_death_asv %>% 
  filter(type=="death") %>% 
  select(Soil:type, g, start_day, start_abund=start_abund_corr, end_abund=end_abund_corr, change_abund=change_abund_corr, n16S) %>% 
  pivot_longer(cols = -c(Soil, ASV, type), names_to = "variable", values_to = "value") %>% 
  mutate(variable = factor(variable, levels=c("start_day", "g", "n16S", "start_abund", "end_abund", "change_abund"))) %>%
  ggplot(aes(log(abs(value)), color=Soil)) +
  geom_density() +
  facet_wrap(~variable, scales="free") +
  scale_color_manual(values=palette_bw2) +
  labs(title="Death") +
  theme_test() +
  theme(axis.text = element_text(size=10, color="black"),
      axis.title = element_text(size=12),
      legend.text = element_text(size=10),
      legend.title = element_text(size=10),
      panel.border = element_rect(color="black"),
      strip.text = element_text(size = 10),
      strip.background = element_blank())
```

## Statistics

Growth:
# BOOKMARK
```{r}
# NOTE: I don't need to average asvs, can use unaveraged data with lmer
library(lmerTest)
# chg_lmer <- lmer(log(change_abund_corr) ~ group + (1 + Inoculant | Inoculant), growth_grp)
# hist(resid(chg_lmer))
# plot(predict(chg_lmer), resid(chg_lmer))
# anova(chg_lmer)
```

Death:

# Gaussian mixture modeling

```{r}
library(mclust)
set.seed(3)
```

## Growth k

```{r}
# Agricultural

# Visualize
ggplot(data=growth_death_asv[growth_death_asv$Soil=="Ag" & growth_death_asv$type=="growth",],
       aes(log(k))) +
  geom_density() +
  theme_test()

# Subset data
k_grag <- growth_death_asv[growth_death_asv$Soil=="Ag" & growth_death_asv$type=="growth",]$k

# Fit univariate gaussian mixture models
agk_mclust <- densityMclust(log(k_grag))
summary(agk_mclust)
plot(agk_mclust$BIC)
agk_mclust$parameters
```

```{r}
# Meadow

# Visualize
ggplot(data=growth_death_asv[growth_death_asv$Soil=="Ag" & growth_death_asv$type=="growth",],
       aes(log(k))) +
  geom_density() +
  theme_test()

# Subset data
k_grmd <- growth_death_asv[growth_death_asv$Soil=="Ag" & growth_death_asv$type=="growth",]$k

# Fit univariate gaussian mixture models
agk_mclust <- densityMclust(log(k_grmd))
summary(agk_mclust)
plot(agk_mclust$BIC)
agk_mclust$parameters
```

## Death k

Fit univariate gaussian mixture models:

# PIN: this seems weird?? look into later
```{r}
# Agricultural

# Visualize
ggplot(data=growth_death_asv[growth_death_asv$Soil=="Ag" & growth_death_asv$type=="death",],
       aes(log(k))) +
  geom_density() +
  theme_test()

# Subset data
k_deag <- growth_death_asv[growth_death_asv$Soil=="Ag" & growth_death_asv$type=="death",]$k

# Fit univariate gaussian mixture models
agd_mclust <- densityMclust(log(k_deag))
summary(agd_mclust)
plot(agd_mclust$BIC)
agd_mclust$parameters
```

```{r}
# Meadow

# Visualize
ggplot(data=growth_death_asv[growth_death_asv$Soil=="Meadow" & growth_death_asv$type=="death",],
       aes(log(k))) +
  geom_density() +
  theme_test()

# Subset data
k_demd <- growth_death_asv[growth_death_asv$Soil=="Meadow" & growth_death_asv$type=="death",]$k

# Fit univariate gaussian mixture models
mdd_mclust <- densityMclust(log(abs(k_demd)))
summary(mdd_mclust)
plot(mdd_mclust$BIC)
mdd_mclust$parameters
```

