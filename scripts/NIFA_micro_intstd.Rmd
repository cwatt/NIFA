---
title: "NIFA micro test internal standard"
author: "Cassandra Wattenburger"
date: "10/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Notes

* Tested 10 randomly chosen samples (that vary in DNA concentration and spike % from last run)
* Tested 3 internal standard spike-ins (3.25, 5, and 6.5 pg)

# Import data

* Counts
* Taxonomy
* Metadata

```{r}
# Micro test data
count <- read_tsv("../data_amplicon/NIFA_micro/final/NIFA_micro.counts-final.tsv")
tax <- read_tsv("../data_amplicon/NIFA_micro/final/NIFA_micro.taxonomy-final.tsv")
meta <- read_tsv("../NIFA_micro_metadata.tsv") %>% 
  mutate(SampleID = as.character(SampleID),
         library = "micro")

# ucosm samples used for testing
ucosms <- unique(meta$ucosm)

# Import first library data and reformat
count_old  <- read_tsv("../data_amplicon/NIFA/final/NIFA.counts-final.tsv")
tax_old <- read_tsv("../data_amplicon/NIFA/final/NIFA.taxonomy-final.tsv")
meta_old <- read_tsv("../NIFA_metadata.tsv") %>% 
  mutate(SampleID = as.character(SampleID),
         library = "old",
         int_std = 0.0129) %>% 
  filter(Microcosm %in% ucosms) %>% 
  select(SampleID, ucosm=Microcosm, int_std, Soil, Day, library)
```

# Isolate internal standard ASVs

* Aquifex aolicus

```{r}
aqui_asvs <- filter(tax, Genus == "Aquifex") %>% 
  select(ASV)

aqui_asvs_old <- filter(tax_old, Genus == "Aquifex") %>% 
  select(ASV)
```

# Calculate count and % int std

```{r}
# Calculate total internal std count per sample
aqui_totals <- count %>%
  filter(ASV %in% aqui_asvs$ASV) %>% 
  column_to_rownames(var="ASV") %>%
  colSums()

aqui_totals_old <- count_old %>%
  filter(ASV %in% aqui_asvs_old$ASV) %>% 
  column_to_rownames(var="ASV") %>%
  colSums()

# Calculate total reads per sample
sample_totals <- count %>% 
  column_to_rownames("ASV") %>% 
  colSums()

sample_totals_old <- count_old %>% 
  column_to_rownames("ASV") %>% 
  colSums()

# Combine and calculate percent aquifex per sample
aqui_perc <- bind_rows(sample_totals, aqui_totals) %>% 
  t() %>% 
  as.data.frame() %>% 
  select(total=V1, aqui=V2) %>% 
  mutate(percent = (aqui/total)*100) %>% 
  rownames_to_column(var="SampleID") %>% 
  inner_join(meta)

aqui_perc_old <- bind_rows(sample_totals_old, aqui_totals_old) %>% 
  t() %>% 
  as.data.frame() %>% 
  select(total=V1, aqui=V2) %>% 
  mutate(percent = (aqui/total)*100) %>% 
  rownames_to_column(var="SampleID") %>% 
  inner_join(meta_old)

# Combine old and test data
aqui_results <- bind_rows(aqui_perc, aqui_perc_old) %>% 
  select(ucosm, int_std, Soil, Day, library, count=aqui, percent)
```

# Visualize

```{r}
# percent
aqui_results %>% 
  ggplot(aes(x=int_std, y=percent)) + 
  geom_boxplot(aes(group=int_std)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  labs(x="Internal std conc. added (pg/ul, 5uL total)", y="Percent internal standard") +
  theme_test()

# counts
aqui_results %>% 
  ggplot(aes(x=int_std, y=count)) + 
  geom_boxplot(aes(group=int_std)) +
  geom_point() +
  geom_smooth(method="lm", linetype=2) +
  labs(x="Internal std conc. added (pg/ul, 5 uL total)", y="Counts of internal standard") +
  theme_test()

summary(lm(percent ~ int_std, data=aqui_results))
summary(lm(count ~ int_std, data=aqui_results))
```

# Summary stats

Percent samples with no internal standard in micro test:

```{r}
aqui_present <- aqui_results %>% 
  filter(library=="micro") %>% 
  mutate(present = if_else(percent > 0, "yes", "no")) 

aqui_present %>% 
  group_by(present) %>% 
  summarize(total=n())
```

Average percent of internal standard:

```{r}
aqui_results %>%
  group_by(int_std) %>% 
  summarize(mean = mean(percent),
            min = min(percent),
            max = max(percent),
            sd = sd(percent))
```

Average counts of aquifex:

```{r}
aqui_results %>% 
  group_by(int_std) %>% 
  summarize(count_mean = mean(count),
            min = min(count),
            max = max(count),
            sd = sd(count))
```

Relationship between amount of internal standard added and percent/counts:

```{r}
aqui_biplots <- aqui_results %>%
  group_by(int_std) %>% 
  summarize(percent_mean = mean(percent),
            percent_min = min(percent),
            percent_max = max(percent),
            percent_sd = sd(percent),
            count_mean = mean(count),
            count_min = min(count),
            count_max = max(count),
            count_sd = sd(count))

aqui_biplots
  
# Int std vs mean percent
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=percent_mean)) +
  geom_point() +
  theme_test()

# Int std vs min percent
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=percent_min)) +
  geom_point() +
  theme_test()

# Int std vs max percent
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=percent_max)) +
  geom_point() +
  theme_test()

# Int std vs sd percent
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=percent_sd)) +
  geom_point() +
  theme_test()

# Int std vs mean counts
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=count_mean)) +
  geom_point() +
  theme_test()

# Int std vs min counts
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=count_min)) +
  geom_point() +
  theme_test()

# Int std vs min counts
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=count_max)) +
  geom_point() +
  theme_test()

# Int std vs min counts
aqui_biplots %>% 
  ggplot(aes(x=int_std, y=count_sd)) +
  geom_point() +
  theme_test()
```



