---
title: "NIFA CO2 analysis"
author: "Cassandra Wattenburger"
date: "5/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
library(tidyverse)

sessionInfo()

rm(list=ls())
```

# Import data

Note: Files exported from Shimadzu PostRun Analysis software as ASCII. In GCMS Postrun Analysis software highlight data files > right click > Output Items > Check Compound Quantitative Result and Qualitative Peak Table with Tab delimitation.

This script is built to run on data that has been stored in a project directory containing a "data" directory with sub-directories for each time point that .txt files with the GCMS output for each sample.

```{r}
# List of directories containing data files
dir <- list.dirs(path="../data_gcms/data", full.names=TRUE, recursive=FALSE)

# Create lists of .txt files from directories
files <- list()
for (i in dir) {
  files[[i]] <- list.files(path=i, pattern="*.txt", full.names=TRUE, recursive=FALSE)
}

# Extract data
# TIC, w/z44 (12C), w/z45 (13C)
co2_df <- data.frame()

for (i in names(files)) { # for each list of files (refers to a directory)
  for (x in files[[i]]) { # for each file in the selected list (directory)
    # Create sample names based on file names
    name <- str_remove(x, "../data_gcms/data/.+/") %>%
      str_remove(".txt")
    
    # Isolate time point info
    date <- str_remove(x, "../data_gcms/data/") %>%
      str_remove("/.+.txt") %>%
      str_remove(".+_")
    tp <- str_remove(x, "../data_gcms/data/") %>%
      str_remove("/.+.txt") %>%
      str_remove("_.+") %>% 
      str_remove("tp")
    
    # Isolate the area data and clean up
    dat <- read_tsv(x, skip=7, col_names=TRUE) %>%
      select("Measurement" = Name, Area) %>% # keep only the name of sample and the area measurements collected
      drop_na() %>%
      mutate(Measurement = case_when(Measurement == "TIC" ~ "Ctotal", # more explicit measurement labels
                              Measurement == "m/z 44" ~ "C12",
                              Measurement == "m/z 45" ~ "C13"),
             TP = tp, # adding additional metadata...
             Date = date,
             Sample = name)
    co2_df <- rbind(co2_df, dat) # add to data frame
  }
}
```

# Reformat data

```{r}
# Reformat
co2_raw <- co2_df %>%
  filter(Sample != "foo") %>%
  mutate(TP = as.numeric(TP),
         type = if_else(grepl("std[0-9]+", Sample), "standard",
                        if_else(grepl("amb", Sample), "ambient",
                                if_else(Sample %in% as.character(191:196), "control", "sample"))))

# Microcosm number metadata
ucosm_nums <- select(co2_raw, Sample, type) %>% 
  filter(type != "standard" | type != "ambient") %>% 
  mutate(Microcosm = as.numeric(Sample)) %>% 
  select(Sample, Microcosm) %>% 
  unique()

# Add metadata
meta <- read_tsv("../NIFA_metadata.tsv") 

tp_days <- meta %>% 
  select(TP=Time_point, Day) %>% 
  unique() %>% 
  filter(!is.na(TP))

soil_litter <- meta %>% 
  mutate(Litter = if_else(Isotope != "None", "litter", "none")) %>% 
  select(Microcosm, Soil, Litter) %>% 
  filter(Soil!="Negative")
  

co2_raw <- co2_raw %>% 
  left_join(tp_days) %>% 
  left_join(ucosm_nums) %>% 
  left_join(soil_litter) %>% 
  select(Sample, Microcosm, type, Soil, Litter, TP, Date, Day, Measurement, Area)

co2_raw 
```

Look at raw data:

```{r}
co2_raw %>% 
  filter(type=="sample") %>% 
  ggplot(aes(x=Day, y=Area, color=Measurement)) +
  geom_point() + 
  facet_wrap(~Measurement) +
  theme_test()

co2_raw %>% 
  filter(type=="sample") %>% 
  ggplot(aes(x=Day, y=Area, color=Measurement)) +
  geom_point() + 
  theme_test()

co2_raw %>% 
  filter(type=="sample" & Measurement=="C13") %>% 
  ggplot(aes(x=Day, y=Area, color=Sample)) +
  geom_point() + 
  theme_test()
```

# Calculate total area

TIC area often does not record (not sure why), so we will use 12C + 13C instead which is a close approximation.

```{r}
# Calculate
co2_prepped <- co2_raw %>%
  filter(Measurement != "Ctotal") %>%
  pivot_wider(names_from = Measurement, values_from = Area) %>%
  mutate(C1213 = C12+C13)
```

# Standards

Separate from samples/atmosphere measurements

```{r}
std_df <- co2_prepped %>%
  filter(type=="standard")
```

Add ppm:

```{r}
# Calculate adjusted areas
std_df <- std_df %>%
  mutate(ppm = case_when(Sample == "std0" ~ 0, # add ppm
                         Sample == "std1" ~ 769,
                         Sample == "std2" ~ 1538,
                         Sample == "std3" ~ 3077,
                         Sample == "std4" ~ 7692,
                         Sample == "std5" ~ 15385,
                         Sample == "std6" ~ 30769)) 
```

Visualize:

```{r}
std_df %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(~Date) +
  theme_test()

std_df %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(aes(group=Date, color=Date), se=F, method="lm") +
  theme_test()
```

There is definitely drift, appears that slope is decreasing? Highest std is most variable. Can it be removed?

Check highest sample area vs std 5

```{r}
sample_df <- co2_prepped %>% 
  filter(type=="sample" | type=="control")

std_sample <- std_df %>% 
  bind_rows(sample_df)

std_sample %>% 
  filter(type %in% c("sample", "standard")) %>% 
  mutate(foo = if_else(type=="standard", Sample, "sample")) %>% 
  ggplot(aes(x=Date, y=C1213, shape=type, color=foo)) +
  geom_point() +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))
```

Highest sample areas are lower than std 5 for each tp and std 6 drifting much more than others.

Date 05/29/23 has strangely compressed lower stds, going to remove and impute based on average of neighbors.

### Impute stds 0-3 for 05/29/23

Average of std Area of neighboring TPs.

```{r}
imp_vals <- std_df %>% 
  filter(Date %in% c("052822", "053122") & Sample %in% c("std0", "std1", "std2", "std3")) %>% 
  group_by(Sample) %>% 
  summarize(C1213_imp = mean(C1213)) 

imp <- std_df %>% 
  filter(Date=="052922" & Sample %in% c("std0", "std1", "std2", "std3")) %>% 
  inner_join(imp_vals) %>% 
  select(Sample:C13, C1213=C1213_imp, ppm)

std_imp <- std_df %>% 
  filter(!(Date == "052922" & Sample %in% c("std0", "std1", "std2", "std3"))) %>% 
  bind_rows(imp)
```

Visualize w/imputed values:

```{r}
# Plot with imputed values:
stdimp_sample <- std_imp %>% 
  bind_rows(sample_df)

stdimp_sample %>% 
  filter(type %in% c("sample", "standard")) %>% 
  mutate(foo = if_else(type=="standard", Sample, "sample")) %>% 
  ggplot(aes(x=Date, y=C1213, shape=type, color=foo)) +
  geom_point() +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))
```

## Remove std 6

Much higher than any of the samples and more prone to drift.

```{r}
std_imp <- std_imp %>% 
  filter(Sample != "std6")

std_imp %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(~Date) +
  theme_test()

std_imp %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(aes(group=Date, color=Date), se=F, method="lm") +
  theme_test()
```

### Calibration curve

```{r}
# Linear regressions for each TP
std_cals <- tibble()
for (d in unique(std_imp$Day)) {
  dat <- filter(std_imp, Day==d) # isolate TP stds
  std_lm <- lm(C1213 ~ ppm, dat)
  this_row <- bind_cols(Day = unique(dat$Day), # save results
                       intercept = summary(std_lm)$coefficients[1,1],
                       slope = summary(std_lm)$coefficients[2,1], 
                       adjR2 = summary(std_lm)$adj.r.squared, 
                       pval = summary(std_lm)$coefficients[2,4])
  std_cals = bind_rows(std_cals, this_row)
}

std_cals
```

# Ambient samples

Isolate ambient samples:

```{r}
amb_df <- co2_prepped %>% 
  filter(type=="ambient") %>% 
  mutate(ppm = 0) # dummy variable for graphing
```

Visualize:

```{r}
# against standards
bind_rows(std_df, amb_df) %>%
  ggplot(aes(x=ppm, y=C1213, color=type)) +
  geom_point() +
  facet_wrap(~Day) +
  theme_test()

# alone
amb_df %>% 
  ggplot(aes(x=Day, y=C1213)) +
  geom_point() +
  geom_smooth(method="lm") +
  geom_line(aes(group=Date)) +
  theme_test()
```

Atmospheric samples are very low, as expected. Ambient 2 is elevated, likely due to slight carry over from std 6, also expected.

# Samples

Convert sample areas into ppm:

```{r}
sample_ppm <- sample_df %>% 
  left_join(std_cals, by="Day") %>%
  select(everything(), -adjR2, -pval) %>% 
  mutate(ppm_total = (C1213 - intercept)/slope, # convert to ppm and correct values before detection threshold
         ppm_total = if_else(ppm_total < 0, 0, ppm_total),
         ppm_12C = (C12 - intercept)/slope,
         ppm_12C = if_else(ppm_12C < 0, 0, ppm_12C),
         ppm_13C = (C13 - intercept)/slope,
         ppm_13C = if_else(ppm_13C < 0, 0, ppm_13C))
```

Visualize:

```{r}
# Total CO2
sample_ppm %>% 
  ggplot(aes(x=Date, y=ppm_total, color=Soil)) +
  geom_point() +
  geom_boxplot() +
  facet_wrap(~Litter) +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

# 13CO2
sample_ppm %>% 
  filter(Litter=="litter") %>% 
  ggplot(aes(x=Date, y=ppm_13C)) +
  geom_point(alpha=0.5) +
  #geom_boxplot() +
  facet_wrap(~Soil, nrow=2) +
  geom_vline(xintercept=12, linetype=2) +
  geom_vline(xintercept=13, linetype=2) +
  geom_text(aes(label=Microcosm), vjust="inward", hjust="inward", color="black") +
  labs(title="13C Litter, 13CO2") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

# 12CO2
sample_ppm %>% 
  filter(Litter=="litter") %>% 
  ggplot(aes(x=Date, y=ppm_12C)) +
  geom_point(alpha=0.5) +
  #geom_boxplot() +
  facet_wrap(~Soil, nrow=2) +
  geom_vline(xintercept=12, linetype=2) +
  geom_vline(xintercept=13, linetype=2) +
  geom_text(aes(label=Microcosm), vjust="inward", hjust="inward", color="black") +
  labs(title="13C Litter, 12CO2") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

# No litter
sample_ppm %>% 
  filter(Litter=="none") %>% 
  ggplot(aes(x=Date, y=ppm_12C)) +
  geom_point(alpha=0.5) +
  geom_vline(xintercept=12, linetype=2) +
  geom_vline(xintercept=13, linetype=2) +
  facet_wrap(~Soil, nrow=2) +
  geom_text(aes(label=Microcosm), vjust="inward", hjust="inward", color="black") +
  labs(title="No litter") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

# No litter
sample_ppm %>% 
  filter(Litter=="none") %>% 
  ggplot(aes(x=Date, y=ppm_13C)) +
  geom_point(alpha=0.5) +
  geom_vline(xintercept=12, linetype=2) +
  geom_vline(xintercept=13, linetype=2) +
  facet_wrap(~Soil, nrow=2) +
  geom_text(aes(label=Microcosm), vjust="inward", hjust="inward", color="black") +
  labs(title="No litter") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))
```

Sample 190, 185, 186 13C have data drop outs, must be issue with headspace sampling or GCMS?

Missing data on Day 05/26/22, according to lab notebook this is the first time the auto-injector on the GCMS first failed, samples were lost.

It looks like no litter Meadow 13C sample on 06/10/22 was maybe mixed up with a litter-added sample, noted.

Notes:
* I think Ag 186 on 5/31/22 is a headspace sampling failure because both 13C and 12C are 0
* Sample Meadow 190 on 5/23/22 and Ag 185 on 6/12/22 likely GCMS error of some sort because 13CO2 measurement very low with expected 12CO2 values

## Impute dropped data

Drop outs:
* Most samples on 05/26/22 (GCMS auto-injector failed and headspace lost)
* Meadow 190 13C on 05/23/22 (13C detection issue?)
* Ag 185 13C on 06/12/22 (13C detection issue?)
* Ag 186 13C and 12C on 05/31/22 (headspace lost)

Calculate averages of nearest neighbors:

# BOOKMARK
```{r}
# Add labels
sample_ppm <- sample_ppm %>% 
  select(Sample:Day, )
  pivot_longer(-Sample:Day, )
  
  
sample_ppm <- sample_ppm %>% 
  mutate(label = paste0(label = paste0(Microcosm, Soil, Litter, Date)))

drop_labs <- c("190Meadowlitterlabelled052322", "185Aglitterlabelled06122", 
               "186Aglitterlabelled053122", "186Aglitterunlabelled053122",
               "187Meadowlitterlabelled052622", "187Meadowlitterunlabelled052622",
               "188Meadowlitterlabelled052622", "188Meadowlitterunlabelled052622",
               "189Meadowlitterlabelled052622", "189Meadowlitterunlabelled052622",
               "190Meadowlitterlabelled052622", "190Meadowlitterunlabelled052622")

# CO2
imp_m13C02190 <- sample_mg %>% 
  filter((Microcosm==190 & isotope=="labelled" & molecule=="CO2" & Soil=="Meadow") & (Date=="052222" | Date=="052422")) %>%
  summarize(mean(mg)) %>% 
  as.numeric()

imp_ag13C02185 <- sample_mg %>% 
  filter((Microcosm==185 & isotope=="labelled" & molecule=="CO2" & Soil=="Ag") & (Date=="061022" | Date=="061422")) %>%
  summarize(mean(mg)) %>% 
  as.numeric()

imp_ag13C02186 <- sample_mg %>% 
  filter((Microcosm==186 & isotope=="labelled" & molecule=="CO2" & Soil=="Ag") & (Date=="052922" | Date=="060222")) %>%
  summarize(mean(mg)) %>% 
  as.numeric()

imp_ag12C02186 <- sample_mg %>% 
  filter((Microcosm==186 & isotope=="unlabelled" & molecule=="CO2" & Soil=="Ag") & (Date=="052922" | Date=="060222")) %>%
  summarize(mean(mg)) %>% 
  as.numeric()
```

Replace:

```{r}
drop_labs <- 

sample_imp <- sample_mg %>% 
  mutate(label = paste0(Microcosm, Soil, Litter, isotope, molecule))
```






Calculate mg C:

```{r}
# Ideal gas law: n=(P*V)/(R*temp)
# NOTE: pressure does not matter for this calulation because it's all relative to the stds
R <- 0.082057338 # universal gas constant, (L*atm)/(mol*K)
temp <- 296.48 # K, 74F in lab throughout experiment
V_m <- 0.1 # L, headspace of 100 mL serum bottle with soil, meadow
V_ag <- 0.104 # L, headspace of 100 mL serum bottle with soil, ag
mwCO2 <- 44.01 # molecular weight (g/mol) of CO2
P <- 1 #atm, assumes 1 atm in ucosms during sampling

# mol CO2 if headspace were 100% CO2
mol_ag100 <- P*V_ag/(R*temp)
mol_m100 <- P*V_m/(R*temp)

# mg CO2 if headspace were 100% CO2
mg_ag100 <- mol_ag100*mwCO2*1000
mg_m100 <- mol_m100*mwCO2*1000

# Convert to mass based on ppm
sample_mg <- sample_ppm %>% 
  mutate(mg_12CO2 = if_else(Soil=="Ag", mg_ag100*(ppm_12C*10^-6), mg_m100*(ppm_12C*10^-6)),
         mg_13CO2 = if_else(Soil=="Ag", mg_ag100*(ppm_13C*10^-6), mg_m100*(ppm_13C*10^-6)),
         mg_12C = mg_12CO2*0.273,
         mg_13C = mg_13CO2*0.273) %>%
  pivot_longer(!Sample:ppm_13C, names_to = "respiration", values_to = "mg") %>%
  mutate(isotope = if_else(grepl("12C", respiration), "unlabelled", "labelled"),
         molecule = if_else(grepl("CO2", respiration), "CO2", "C")) %>%
  select(Sample:Day, isotope, molecule, respiration, mg)
```

Visualize:

```{r}
sample_mg %>% 
  filter(molecule=="CO2") %>% 
  ggplot(aes(x=Date, y=mg, color=isotope)) +
  geom_point() +
  facet_wrap(Litter~Soil) +
  labs(title="CO2") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

sample_mg %>% 
  filter(molecule=="C") %>% 
  ggplot(aes(x=Date, y=mg, color=isotope)) +
  geom_point() +
  facet_wrap(Litter~Soil) +
  labs(title="C") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))
```



# WIP

Save processed CO2 data:

```{r, eval=FALSE}
```

# Total CO2/C

### Total

```{r}
# Sum time points
total_co2 <- sample_df %>% 
  group_by(Soil, Replicate, litter) %>% 
  summarize(total_co2 = sum(ppm_total)) %>% 
  ungroup()

# Summarize 
total_co2 %>% 
  group_by(Soil, litter) %>% 
  summarize(avg_co2 = mean(total_co2), sd_co2 = sd(total_co2))

# Visualize
total_co2 %>%
  ggplot(aes(x=Soil, y=total_co2, color=litter)) +
  geom_point() +
  theme_test()
```

Quickie stats:

```{r}
# Linear model
totalco2_lm <- lm(total_co2 ~ Soil, filter(total_co2, litter=="Litter"))
hist(resid(totalco2_lm))
plot(predict(totalco2_lm), resid(totalco2_lm)) # heteroskedastic

# Welch's t-test instead
t.test(total_co2 ~ Soil, filter(total_co2, litter=="Litter"), var.equal=FALSE)
```

### 13CO2

```{r}
# Sum time points
total_13co2 <- sample_df %>% 
  mutate(ppm_13C = if_else(ppm_13C < 0, 0, ppm_13C)) %>% # remove negative intercepts
  group_by(Soil, Replicate, litter) %>% 
  summarize(total_13co2 = sum(ppm_13C)) %>% 
  ungroup()

# Summary
total_13co2 %>% 
  group_by(Soil, litter) %>% 
  summarize(avg_13co2 = mean(total_13co2), sd_13co2 = sd(total_13co2))

# Visualize
total_13co2 %>%
  ggplot(aes(x=Soil, y=total_13co2, color=litter)) +
  geom_point() +
  theme_test()
```

Quickie stats:

```{r}
# Linear model
total13co2_lm <- lm(total_13co2 ~ Soil, filter(total_13co2, litter=="Litter"))
hist(resid(total13co2_lm))
plot(predict(total13co2_lm), resid(total13co2_lm)) # heteroskedastic

# Welch's t-test instead
t.test(total_13co2 ~ Soil, filter(total_13co2, litter=="Litter"), var.equal=FALSE)
```

### 12CO2

```{r}
# Sum time points
total_12co2 <- sample_df %>% 
  mutate(ppm_12C = if_else(ppm_12C < 0, 0, ppm_12C)) %>% # remove negative intercepts
  group_by(Soil, Replicate, litter) %>% 
  summarize(total_12co2 = sum(ppm_12C)) %>% 
  ungroup()

# Summary
total_12co2 %>% 
  group_by(Soil, litter) %>% 
  summarize(avg_12co2 = mean(total_12co2), sd_12co2 = sd(total_12co2))

# Visualize
total_12co2 %>%
  ggplot(aes(x=Soil, y=total_12co2, color=litter)) +
  geom_point() +
  theme_test()
```


# SCRAP

Test for autocorrelation in time series:

```{r}
ts_190M13CO2 <- sample_mg %>% 
  filter(Microcosm==190 & isotope=="labelled" & molecule=="CO2" & Soil=="Meadow") %>% # isolate Meadow 13CO2 time series
  filter(Date!="052322") %>% # remove drop out time point for autocorrelation test
  select(mg) %>% # convert into ts object type
  as.ts() 

ts_186Ag13CO2 <- sample_mg %>% 
  filter(Microcosm==186 & isotope=="labelled" & molecule=="CO2" & Soil=="Ag") %>% # isolate Meadow 13CO2 time series
  filter(Date!="052322") %>% # remove drop out time point for autocorrelation test
  select(mg) %>% # convert into ts object type
  as.ts()
  
# Autocorrelation
pacf(ts_190M13CO2)
pacf(ts_186Ag13CO2)
```

Could this be used to test for oscillation in bacterial abundance data?


