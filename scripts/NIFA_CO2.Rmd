---
title: "NIFA CO2 analysis"
author: "Cassandra Wattenburger"
date: "5/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
library(tidyverse)

sessionInfo()

rm(list=ls())
```

# Import data

Note: Files exported from Shimadzu PostRun Analysis software as ASCII. In GCMS Postrun Analysis software highlight data files > right click > Output Items > Check Compound Quantitative Result and Qualitative Peak Table with Tab delimitation.

This script is built to run on data that has been stored in a project directory containing a "data" directory with sub-directories for each time point that .txt files with the GCMS output for each sample.

```{r}
# List of directories containing data files
dir <- list.dirs(path="../data_gcms/data", full.names=TRUE, recursive=FALSE)

# Create lists of .txt files from directories
files <- list()
for (i in dir) {
  files[[i]] <- list.files(path=i, pattern="*.txt", full.names=TRUE, recursive=FALSE)
}

# Extract data
# TIC, w/z44 (12C), w/z45 (13C)
co2_df <- data.frame()

for (i in names(files)) { # for each list of files (refers to a directory)
  for (x in files[[i]]) { # for each file in the selected list (directory)
    # Create sample names based on file names
    name <- str_remove(x, "../data_gcms/data/.+/") %>%
      str_remove(".txt")
    
    # Isolate time point info
    date <- str_remove(x, "../data_gcms/data/") %>%
      str_remove("/.+.txt") %>%
      str_remove(".+_")
    tp <- str_remove(x, "../data_gcms/data/") %>%
      str_remove("/.+.txt") %>%
      str_remove("_.+") %>% 
      str_remove("tp")
    
    # Isolate the area data and clean up
    dat <- read_tsv(x, skip=7, col_names=TRUE) %>%
      select("Measurement" = Name, Area) %>% # keep only the name of sample and the area measurements collected
      drop_na() %>%
      mutate(Measurement = case_when(Measurement == "TIC" ~ "Ctotal", # more explicit measurement labels
                              Measurement == "m/z 44" ~ "C12",
                              Measurement == "m/z 45" ~ "C13"),
             TP = tp, # adding additional metadata...
             Date = date,
             Sample = name)
    co2_df <- rbind(co2_df, dat) # add to data frame
  }
}
```

# Reformat data

```{r}
# Reformat
co2_raw <- co2_df %>%
  filter(Sample != "foo") %>%
  mutate(TP = as.numeric(TP),
         type = if_else(grepl("std[0-9]+", Sample), "standard",
                        if_else(grepl("amb", Sample), "ambient",
                                if_else(Sample %in% as.character(191:196), "control", "sample"))))

# Microcosm number metadata
ucosm_nums <- select(co2_raw, Sample, type) %>% 
  filter(type != "standard" | type != "ambient") %>% 
  mutate(Microcosm = as.numeric(Sample)) %>% 
  select(Sample, Microcosm) %>% 
  unique()

# Add metadata
meta <- read_tsv("../NIFA_metadata.tsv") 

tp_days <- meta %>% 
  select(TP=Time_point, Day) %>% 
  unique() %>% 
  filter(!is.na(TP))

soil_litter <- meta %>% 
  mutate(Litter = if_else(Isotope != "None", "litter", "none")) %>% 
  select(Microcosm, Soil, Litter) %>% 
  filter(Soil!="Negative")
  

co2_raw <- co2_raw %>% 
  left_join(tp_days) %>% 
  left_join(ucosm_nums) %>% 
  left_join(soil_litter) %>% 
  select(Sample, Microcosm, type, Soil, Litter, TP, Date, Day, Measurement, Area)

co2_raw 
```

Look at raw data:

```{r}
co2_raw %>% 
  filter(type=="sample") %>% 
  ggplot(aes(x=Day, y=Area, color=Measurement)) +
  geom_point() + 
  facet_wrap(~Measurement) +
  theme_test()

co2_raw %>% 
  filter(type=="sample") %>% 
  ggplot(aes(x=Day, y=Area, color=Measurement)) +
  geom_point() + 
  theme_test()

co2_raw %>% 
  filter(type=="sample" & Measurement=="C13") %>% 
  ggplot(aes(x=Day, y=Area, color=Sample)) +
  geom_point() + 
  theme_test()
```

# Calculate total area

TIC area often does not record (not sure why), so we will use 12C + 13C instead which is a close approximation.

```{r}
# Calculate
co2_prepped <- co2_raw %>%
  filter(Measurement != "Ctotal") %>%
  pivot_wider(names_from = Measurement, values_from = Area) %>%
  mutate(C1213 = C12+C13)
```

# Standards

Separate from samples/atmosphere measurements

```{r}
std_df <- co2_prepped %>%
  filter(type=="standard")
```

Add ppm:

```{r}
# Calculate adjusted areas
std_df <- std_df %>%
  mutate(ppm = case_when(Sample == "std0" ~ 0, # add ppm
                         Sample == "std1" ~ 769,
                         Sample == "std2" ~ 1538,
                         Sample == "std3" ~ 3077,
                         Sample == "std4" ~ 7692,
                         Sample == "std5" ~ 15385,
                         Sample == "std6" ~ 30769)) 
```

Visualize:

```{r}
std_df %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(~Date) +
  theme_test()

std_df %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(aes(group=Date, color=Date), se=F, method="lm") +
  theme_test()
```

There is definitely drift, appears that slope is decreasing? Highest std is most variable. Can it be removed?


# Check highest sample area vs std 5

```{r}
sample_df <- co2_prepped %>% 
  filter(type=="sample" | type=="control")

std_sample <- std_df %>% 
  bind_rows(sample_df)

std_sample %>% 
  filter(type %in% c("sample", "standard")) %>% 
  mutate(foo = if_else(type=="standard", Sample, "sample")) %>% 
  ggplot(aes(x=Date, y=C1213, shape=type, color=foo)) +
  geom_point() +
  theme_test()
```

Highest sample areas are lower than std 5 for each tp and std 6 driftiing more than others.

Remove std 6:

```{r}
std_df <- std_df %>% 
  filter(Sample != "std6")

std_df %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(~Date) +
  theme_test()

std_df %>%
  ggplot(aes(x=ppm, y=C1213)) +
  geom_point() +
  geom_smooth(aes(group=Date, color=Date), se=F, method="lm") +
  theme_test()
```

### Calibration curve

```{r}
# Linear regressions for each TP
std_cals <- tibble()
for (d in unique(std_df$Day)) {
  dat <- filter(std_df, Day==d) # isolate TP stds
  std_lm <- lm(C1213 ~ ppm, dat)
  this_row <- bind_cols(Day = unique(dat$Day), # save results
                       intercept = summary(std_lm)$coefficients[1,1],
                       slope = summary(std_lm)$coefficients[2,1], 
                       adjR2 = summary(std_lm)$adj.r.squared, 
                       pval = summary(std_lm)$coefficients[2,4])
  std_cals = bind_rows(std_cals, this_row)
}

std_cals
```

# Ambient samples

Isolate ambient samples:

```{r}
amb_df <- co2_prepped %>% 
  filter(type=="ambient") %>% 
  mutate(ppm = 0) # dummy variable for graphing
```

Visualize:

```{r}
# against standards
bind_rows(std_df, amb_df) %>%
  ggplot(aes(x=ppm, y=C1213, color=type)) +
  geom_point() +
  facet_wrap(~Day) +
  theme_test()

# alone
amb_df %>% 
  ggplot(aes(x=Day, y=C1213)) +
  geom_point() +
  geom_smooth(method="lm") +
  geom_line(aes(group=Date)) +
  theme_test()
```

Atmospheric samples are very low, as expected. Ambient 2 is elevated, likely due to slight carry over from std 6, also expected.

# Samples

Use calibration curve to convert sample areas into ppm:

```{r}
sample_ppm <- sample_df %>% 
  left_join(std_cals, by="Day") %>%
  select(everything(), -adjR2, -pval) %>% 
  mutate(ppm_total = (C1213 - intercept)/slope, # convert to ppm and correct values before detection threshold
         ppm_total = if_else(ppm_total < 0, 0, ppm_total),
         ppm_12C = (C12 - intercept)/slope,
         ppm_12C = if_else(ppm_12C < 0, 0, ppm_12C),
         ppm_13C = (C13 - intercept)/slope,
         ppm_13C = if_else(ppm_13C < 0, 0, ppm_13C))
```

Visualize:

```{r}
# Total CO2
sample_ppm %>% 
  ggplot(aes(x=Date, y=ppm_total, color=Soil)) +
  geom_point() +
  geom_boxplot() +
  facet_wrap(~Litter) +
  theme_test()

# 13CO2
sample_ppm %>% 
  filter(Litter=="litter") %>% 
  ggplot(aes(x=Date, y=ppm_13C)) +
  geom_point(alpha=0.5) +
  #geom_boxplot() +
  facet_wrap(~Soil, nrow=2) +
  geom_vline(xintercept=13) +
  geom_text(aes(label=Microcosm), vjust="inward", hjust="inward", color="black") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

# 12CO2
sample_ppm %>% 
  filter(Litter=="litter") %>% 
  ggplot(aes(x=Date, y=ppm_12C)) +
  geom_point(alpha=0.5) +
  #geom_boxplot() +
  facet_wrap(~Soil, nrow=2) +
  geom_vline(xintercept=13) +
  geom_text(aes(label=Microcosm), vjust="inward", hjust="inward", color="black") +
  theme_test() +
  theme(axis.text.x = element_text(angle=45))

# No litter
sample_ppm %>% 
  filter(Litter=="none") %>% 
  ggplot(aes(x=Day, y=ppm_12C)) +
  geom_point(alpha=0.5) +
  #geom_boxplot() +
  facet_wrap(~Soil, nrow=2) +
  geom_vline(xintercept=13) +
  geom_text(aes(label=Microcosm), vjust="inward", hjust="inward", color="black") +
  theme_test()
```

Notes:
* I think sample 186 on 5/31 is a failure because both 13C and 12C are 0
* Why is 13C so low on 5/29? 12C isn't?? If leakage issue both would be low???
* more like a below detection threshold issue due to slope and intercept of stds?

Calculate mg C:

# BOOKMARK

# need estimate on headspace of serum bottles with soil

```{r}
# Ideal gas law: n=(P*V)/(R*temp)
# NOTE: pressure does not matter for this calulation because it's all relative to the stds
R <- 0.082057338 # universal gas constant, (L*atm)/(mol*K)
temp <- 296.48 # K, 74F in lab throughout experiment
V <- 0.013 # L, headspace of 30 mL serum bottle with soil
mwCO2 <- 44.01 # molecular weight (g/mol) of CO2
P <- 1 #atm, assumes 1 atm in ucosms during sampling

# Calculate per time point
molCO2100 <- P*V/(R*temp) # total mol of CO2 in headspace, if it were 100% CO2
mgCO2100 <- molCO2100 * mwCO2*1000 # mol * g/mol * 1000mg/g = mg, mg of CO2 present if it were 100% CO2

sample_mgC <- sample_ppm %>% 
  mutate(mg_12co2 = mgCO2100*(ppm_12C*10^-6),
         mg_12c = mg_12co2*0.273, # 27% of mol. mass of co2 is C
         mg_13co2 = mgCO2100*(ppm_13C*10^-6),
         mg_13c = mg_13co2*0.273) # 27% of mol. mass of co2 is C
```

Save processed CO2 data:

```{r, eval=FALSE}
```


# CO2 rate / day

```{r}

```


# Cumulative CO2

### Total

```{r}
# Sum time points
total_co2 <- sample_df %>% 
  group_by(Soil, Replicate, litter) %>% 
  summarize(total_co2 = sum(ppm_total)) %>% 
  ungroup()

# Summarize 
total_co2 %>% 
  group_by(Soil, litter) %>% 
  summarize(avg_co2 = mean(total_co2), sd_co2 = sd(total_co2))

# Visualize
total_co2 %>%
  ggplot(aes(x=Soil, y=total_co2, color=litter)) +
  geom_point() +
  theme_test()
```

Quickie stats:

```{r}
# Linear model
totalco2_lm <- lm(total_co2 ~ Soil, filter(total_co2, litter=="Litter"))
hist(resid(totalco2_lm))
plot(predict(totalco2_lm), resid(totalco2_lm)) # heteroskedastic

# Welch's t-test instead
t.test(total_co2 ~ Soil, filter(total_co2, litter=="Litter"), var.equal=FALSE)
```

### 13CO2

```{r}
# Sum time points
total_13co2 <- sample_df %>% 
  mutate(ppm_13C = if_else(ppm_13C < 0, 0, ppm_13C)) %>% # remove negative intercepts
  group_by(Soil, Replicate, litter) %>% 
  summarize(total_13co2 = sum(ppm_13C)) %>% 
  ungroup()

# Summary
total_13co2 %>% 
  group_by(Soil, litter) %>% 
  summarize(avg_13co2 = mean(total_13co2), sd_13co2 = sd(total_13co2))

# Visualize
total_13co2 %>%
  ggplot(aes(x=Soil, y=total_13co2, color=litter)) +
  geom_point() +
  theme_test()
```

Quickie stats:

```{r}
# Linear model
total13co2_lm <- lm(total_13co2 ~ Soil, filter(total_13co2, litter=="Litter"))
hist(resid(total13co2_lm))
plot(predict(total13co2_lm), resid(total13co2_lm)) # heteroskedastic

# Welch's t-test instead
t.test(total_13co2 ~ Soil, filter(total_13co2, litter=="Litter"), var.equal=FALSE)
```

### 12CO2

```{r}
# Sum time points
total_12co2 <- sample_df %>% 
  mutate(ppm_12C = if_else(ppm_12C < 0, 0, ppm_12C)) %>% # remove negative intercepts
  group_by(Soil, Replicate, litter) %>% 
  summarize(total_12co2 = sum(ppm_12C)) %>% 
  ungroup()

# Summary
total_12co2 %>% 
  group_by(Soil, litter) %>% 
  summarize(avg_12co2 = mean(total_12co2), sd_12co2 = sd(total_12co2))

# Visualize
total_12co2 %>%
  ggplot(aes(x=Soil, y=total_12co2, color=litter)) +
  geom_point() +
  theme_test()
```


