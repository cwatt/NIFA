---
title: 'NIFA - dynamic time warping and hierarchical clustering'
author: "Cassandra Wattenburger"
date: "3/8/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
# Clear working directory, load in packages, generate package info
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Import, prep data

```{r}
# Normalized abundances
ts_abund <- readRDS("../data_intermediate/NIFA_norm_prepped.rds")

# Growth estimates
growth <- readRDS("../data_intermediate/NIFA_grests_final_ind.rds")
# Growing taxa labels
growth_labs <- growth %>% 
  select(label) %>% 
  unique()

# Reformat
# Remove no-growth time series
ts_abund_gr <- ts_abund %>% 
  semi_join(growth_labs)

# Series numbers
ts_nums <- ts_abund_gr %>%
  select(label) %>%
  unique() %>% 
  add_column(ts = 1:nrow(.))

# Clean up
ts_abund_gr <- left_join(ts_abund_gr, ts_nums) %>% 
  select(ts, label, day=Day, abund=norm_abund)


# TROUBLESHOOTING
ts_abund_gr %>% 
  group_by(ts) %>% 
  summarize(days = n()) %>% 
  ungroup() 
```

Visualize:

Raw time series

```{r}
# Randomly select 50 time series for preprocessing comparisons
set.seed(50)
rand_ts <- sample(unique(ts_abund_gr$ts), 20)
```

```{r}
# All
ts_abund_gr %>% 
  ggplot(aes(x=day, y=abund)) +
  geom_line(aes(group=ts), alpha=0.2) +
  labs(title="All") +
  theme_test()

# random 50
ts_abund_gr %>% 
  filter(ts %in% rand_ts) %>% 
  ggplot(aes(x=day, y=abund)) +
  geom_line(aes(group=ts, color=label)) +
  labs(title="50 random") +
  theme_test() +
  theme(legend.position = "none")
```

# Preprocessing

## ln transform

This is how bacterial growth data is typically viewed and interpretted due to exponential growth characteristic.

Decreases impact of differences in starting or ending abundances on dissimilarity.

```{r}
ts_abund_gr <- ts_abund_gr %>% 
  mutate(abund_ln = log(abund))
```

Visualize:

```{r}
# All
ts_abund_gr %>% 
  ggplot(aes(x=day, y=abund_ln)) +
  geom_line(aes(group=ts), alpha=0.2) +
  labs(title="All") +
  theme_test()

# random 50
ts_abund_gr %>% 
  filter(ts %in% rand_ts) %>% 
  ggplot(aes(x=day, y=abund_ln)) +
  geom_line(aes(group=ts, color=label)) +
  labs(title="50 random") +
  theme_test() +
  theme(legend.position = "none")
```

## Min/max normalize

x_norm = (x - min)/(max - min)

Forces time series between 0 and 1 so that all time series are within comparable range.

```{r}
# Mins and maxes of each time series
ts_minmax <- ts_abund_gr %>% 
  group_by(label) %>% 
  summarize(ts_min = min(abund_ln),
            ts_max = max(abund_ln))

# Normalize
# y = (x - min) / (max - min)
ts_abund_gr <- ts_abund_gr %>% 
  left_join(ts_minmax, by="label") %>%
  mutate(abund_norm = (abund_ln - ts_min)/(ts_max - ts_min)) %>% 
  select(ts, label, day, abund, abund_ln, abund_norm)
```

Visualize:

```{r}
# All
ts_abund_gr %>% 
  ggplot(aes(x=day, y=abund_norm)) +
  geom_line(aes(group=ts), alpha=0.2) +
  labs(title="All") +
  theme_test()

# random 50
ts_abund_gr %>% 
  filter(ts %in% rand_ts) %>% 
  ggplot(aes(x=day, y=abund_norm)) +
  geom_line(aes(group=ts, color=label)) +
  labs(title="50 random") +
  theme_test() +
  theme(legend.position = "none")
```

## Reformat to list

DTW function with parallelization likes this format.

```{r}
# Wide format
ts_abund_wide <- ts_abund_gr %>% 
  select(ts, label, day, abund_norm) %>% 
  pivot_wider(names_from=day, values_from=abund_norm)

# Create named list of time series
ts_abund_list <- list()
labels <- as.character(ts_abund_wide$label)
for (i in 1:nrow(ts_abund_wide)) {
  ts <- ts_abund_wide[i, 3:ncol(ts_abund_wide)] %>% 
    as.numeric() %>% 
    na.omit() %>% 
    as.numeric()
  temp_list <- lst(ts)
  ts_abund_list <- c(ts_abund_list, temp_list)
}
names(ts_abund_list) <- labels
```

# DTW

Set up multithreading for dtwclust():

https://cran.r-project.org/web/packages/dtwclust/vignettes/parallelization-considerations.html

```{r}
# Set up multithreading with most of the server's processors (80 of 96)
## Restart R to change number of threads
library("parallel")
library("doParallel")

workers <- makeCluster(48)

invisible(clusterEvalQ(workers, {
    library(dtwclust)
    RcppParallel::setThreadOptions(1L)
}))

require(doParallel)
registerDoParallel(workers)
```

All pairwise comparisons:

Using defaults, cannot place lowerbounds due to differing time series lengths.

```{r}
library("dtwclust")

dtw_dist <- proxy::dist(ts_abund_list, method = "dtw_basic")
```

# Principle components

```{r}
dtw_pc <- prcomp(dtw_dist)
head(summary(dtw_pc)$importance[3,])
plot(summary(dtw_pc)$importance[3,])
```

First two components describe 65% of variation, not bad.

Visualize:

```{r}
dtw_pc_df <- dtw_pc$x %>% 
  as.data.frame() %>% 
  rownames_to_column(var="label")

dtw_pc_df %>% 
  ggplot(aes(x=PC1, y=PC2)) +
  geom_point() + 
  theme_test()
```

# Hierarchical clustering

Agglomerative:

```{r}
library("factoextra")
library("cluster")

# Single, complete, and average
agnes_sing <- agnes(dtw_dist, metric="euclidean", method = "single")
agnes_compl <- agnes(dtw_dist, metric="euclidean", method = "complete")
agnes_avg <- agnes(dtw_dist, metric="euclidean", method = "average")

agnes_sing$ac
agnes_compl$ac
agnes_avg$ac
```

Complete linkage provides the best agglomerative coefficient.

Devisive:

```{r}
diana_euc <- diana(dtw_dist)
diana_euc$dc
```

Agglomerative hierarchical clustering with complete linkage seems to give best cluster cohesion.

# Cluster number

Scree and height gap plots:

Graphing functions: https://tomytjandra.github.io/blogs/r/time-series/clustering/2020/11/04/time-series-hierarchical-clustering.html#Determine-optimal-clusters

```{r}
# Function
scree_plot_hc <- function(hc, which.plots = 1) {
  df <-
    data.frame(k = 1:length(hc$height),
               h = rev(sort(hc$height))) %>% 
    mutate(gap = abs(h - lag(h)))
  
  if (which.plots == 1) {
    
    p <- ggplot(df, aes(x = k, y = h)) +
      geom_line(color = 'blue') +
      geom_point(size = 0.75) +
      labs(x = "Number of clusters k",
           y = "Height",
           title = "Scree Plot") +
      theme_classic()
    
    print(p)
    
  } else if (which.plots == 2) {
    
    df %>% 
      arrange(desc(gap)) %>% 
      top_n(10) %>% 
      ggplot(aes(x = reorder(k, -gap), y = gap)) +
      geom_col() +
      labs(x = "Number of clusters k",
           y = "Height Gap",
           title = "Largest Gap Method") +
      theme_classic()
    
  }
}
```

```{r}
scree_plot_hc(agnes_compl, which.plots = 1)
scree_plot_hc(agnes_compl, which.plots = 2)
```

Silohuettes:

Describes similarity of observation to its own cluster. Positive silhouette width is more similar, negative is less similar.

```{r}
# 4 clusters
hc_4 <- cutree(agnes_compl, k = 4)
sil_4 <- silhouette(hc_4, dtw_dist)
sil_4_df <- data.frame(sil_4)

sil_4_df %>% 
  summarize(mean(sil_width))

sil_4_df %>% 
  mutate(cluster = as.factor(cluster)) %>% 
  ggplot(aes(x=sil_width, y=cluster, color=cluster)) +
  geom_jitter() +
  geom_vline(xintercept = 0, linetype = 2) +
  labs(title="4 clusters")
  theme_test()

# 8 clusters
hc_8 <- cutree(agnes_compl, k = 8)
sil_8 <- silhouette(hc_8, dtw_dist)
sil_8_df <- data.frame(sil_8)

sil_8_df %>% 
  summarize(mean(sil_width))

sil_8_df %>% 
  mutate(cluster = as.factor(cluster)) %>% 
  ggplot(aes(x=sil_width, y=cluster, color=cluster)) +
  geom_jitter() +
  geom_vline(xintercept = 0, linetype = 2) +
  labs(title="8 clusters")
  theme_test()
  
# 10 clusters
hc_10 <- cutree(agnes_compl, k = 10)
sil_10 <- silhouette(hc_10, dtw_dist)
sil_10_df <- data.frame(sil_10)

sil_10_df %>% 
  summarize(mean(sil_width))

sil_10_df %>% 
  mutate(cluster = as.factor(cluster)) %>% 
  ggplot(aes(x=sil_width, y=cluster, color=cluster)) +
  geom_jitter() +
  geom_vline(xintercept = 0, linetype = 2) +
  labs(title="10 clusters")
  theme_test()
```

Average silohuette width is very close to 0, must be lots of overlap between clusters?

# Visualize clusters

PC1 and PC2 with cluster color-coding:

```{r}
# 4 clusters
final_cluster4 <- cutree(as.hclust(agnes_compl), k = 4)
table(final_cluster4)

cluster_mapping4 <- rownames_to_column(as.data.frame(final_cluster4),
                     var = "label") %>% 
  rename(cluster = final_cluster4) %>% 
  mutate(cluster = as.factor(cluster))

dtw_pc_df %>% 
  left_join(cluster_mapping4) %>% 
  ggplot(aes(x=PC1, y=PC2, color=cluster)) +
  geom_point() + 
  theme_test()

# How many observations in each cluster?
dtw_pc_df %>% 
  left_join(cluster_mapping4) %>% 
  group_by(cluster) %>% 
  summarize(total=n())

# 8 clusters
final_cluster8 <- cutree(as.hclust(agnes_compl), k = 8)
table(final_cluster8)

cluster_mapping8 <- rownames_to_column(as.data.frame(final_cluster8),
                     var = "label") %>% 
  rename(cluster = final_cluster8) %>% 
  mutate(cluster = as.factor(cluster))

dtw_pc_df %>% 
  left_join(cluster_mapping8) %>% 
  ggplot(aes(x=PC1, y=PC2, color=cluster)) +
  geom_point() + 
  theme_test()

# How many observations in each cluster?
dtw_pc_df %>% 
  left_join(cluster_mapping8) %>% 
  group_by(cluster) %>% 
  summarize(total=n())

# 10 clusters
final_cluster10 <- cutree(as.hclust(agnes_compl), k = 10)
table(final_cluster10)

cluster_mapping10 <- rownames_to_column(as.data.frame(final_cluster10),
                     var = "label") %>% 
  rename(cluster = final_cluster10) %>% 
  mutate(cluster = as.factor(cluster))

dtw_pc_df %>% 
  left_join(cluster_mapping10) %>% 
  ggplot(aes(x=PC1, y=PC2, color=cluster)) +
  geom_point() + 
  theme_test()

# How many observations in each cluster?
dtw_pc_df %>% 
  left_join(cluster_mapping10) %>% 
  group_by(cluster) %>% 
  summarize(total=n())
```

10 clusters results in a more even distribution of estimates and breaks up that one gigantic cluster more.

Dendrogram:

```{r}
library("dendextend")

# Clusters on dendrograms
dend_viz4 <- color_branches(as.hclust(agnes_compl), k = 4)
dend_viz8 <- color_branches(as.hclust(agnes_compl), k = 8)
dend_viz10 <- color_branches(as.hclust(agnes_compl), k = 10)

# Visualize
plot(dend_viz4)
plot(dend_viz8)
plot(dend_viz10)
```

# Barycenters

# PIN: not working well

```{r, eval=FALSE, warning=FALSE}
# Time series means
ts_mean <- ts_abund_gr %>% 
  group_by(label) %>% 
  summarize(ts_mean = mean(abund_ln)) %>% 
  ungroup()

# Offset and add cluster info
ts_abund_dba <- ts_abund_gr %>%
  left_join(ts_mean) %>% 
  mutate(abund_offset = abund_ln - ts_mean) %>% 
  select(label, day, abund_offset) %>% 
  pivot_wider(names_from=day, values_from=abund_offset) %>% 
  left_join(cluster_mapping10)

# Convert to lists
for (c in c(1:10)) { # each cluster
  ts_abund_sub <- filter(ts_abund_dba, cluster==c) %>% 
    select(-cluster)
  x <- list()
   # create object for cluster
  for (i in 1:nrow(ts_abund_sub)) { # each time series
    ts <- ts_abund_sub[i,] %>% 
      as.numeric() %>% 
      na.omit() %>% 
      as.numeric()
    temp_list <- lst(ts)
    x <- c(x, temp_list)
  }
  assign(paste0("ts_abund_dba", c), x)
}

# Calculate barycenter for each cluster
barycenter1 <- shape_extraction(ts_abund_dba1)
barycenter2 <- shape_extraction(ts_abund_dba2)
barycenter3 <- shape_extraction(ts_abund_dba3)
barycenter4 <- shape_extraction(ts_abund_dba4)
barycenter5 <- shape_extraction(ts_abund_dba5)
barycenter6 <- shape_extraction(ts_abund_dba6)
barycenter7 <- shape_extraction(ts_abund_dba7)
barycenter8 <- shape_extraction(ts_abund_dba8)
barycenter9 <- shape_extraction(ts_abund_dba9)
barycenter10 <- shape_extraction(ts_abund_dba10)

# Reformat barycenters into dataframe
barycenters_df <- data.frame(cluster1 = c(barycenter1, rep(NA, 30-length(barycenter1))),
                             cluster2 = c(barycenter2, rep(NA, 30-length(barycenter2))),
                             cluster3 = c(barycenter3, rep(NA, 30-length(barycenter3))),
                             cluster4 = c(barycenter4, rep(NA, 30-length(barycenter4))),
                             cluster5 = c(barycenter5, rep(NA, 30-length(barycenter5))),
                             cluster6 = c(barycenter6, rep(NA, 30-length(barycenter6))),
                             cluster7 = c(barycenter7, rep(NA, 30-length(barycenter7))),
                             cluster8 = c(barycenter8, rep(NA, 30-length(barycenter8))),
                             cluster9 = c(barycenter9, rep(NA, 30-length(barycenter9))),
                             cluster10 = c(barycenter10, rep(NA, 30-length(barycenter10)))) %>% 
  rownames_to_column(var="tp") %>% 
  pivot_longer(-tp, names_to="cluster", values_to="abund_offset") %>% 
  mutate(cluster = as_factor(cluster),
         tp = as.numeric(tp)) %>% 
  na.omit()

# Visualize
barycenters_df %>% 
  ggplot(aes(x=tp, y=abund_offset, color=cluster)) + 
  geom_point() +
  geom_line() +
  facet_wrap(~cluster) +
  theme_test()
```

# Clustered time series

# NOTE: Currently set to 4

```{r}
# Time series data
abund_clust <- ts_abund_gr %>% 
  left_join(cluster_mapping4) %>% 
  mutate(Soil=if_else(grepl("Ag", label), "Ag", "Meadow"),
         Replicate=gsub("[a-z]+([1-3])_(.+)", "\\1", label, ignore.case=TRUE),
         ASV=gsub("[a-z]+([1-3])_(.+)", "\\2", label, ignore.case=TRUE)) %>% 
  select(label, Soil, Replicate, ASV, ts, day, cluster, abund:abund_norm)
  
# Growth estimates
growth_clust <- growth %>%
  left_join(cluster_mapping4)
```

Visualize:

```{r}
for (c in c(1:4)) { # each cluster
  title <- paste0("Cluster ", c)
  p <- abund_clust %>% 
    filter(cluster==c) %>% 
    ggplot(aes(x=day, y=abund_ln)) +
    geom_point(alpha=0.5) +
    geom_line(aes(group=label), alpha=0.5) +
    labs(title=title) +
    theme_test() 
    print(p)
}
```

Randomly draw 10 from each cluster:

```{r}
rand10 <- cluster_mapping4 %>% 
  group_by(cluster) %>% 
  slice_sample(n=10)

for (c in c(1:4)) { # each cluster
  title <- paste0("Cluster ", c)
  p <- abund_clust %>% 
    semi_join(rand10) %>% 
    filter(cluster==c) %>% 
    ggplot(aes(x=day, y=abund_ln, color=label)) +
    geom_point(alpha=0.5) +
    geom_line(aes(group=label), alpha=0.5) +
    labs(title=title) +
    theme_test() +
    theme(legend.position = "none")
  print(p)
}

# Smoothed version
for (c in c(1:4)) { # each cluster
  title <- paste0("Cluster ", c)
  p <- abund_clust %>% 
    semi_join(rand10) %>% 
    filter(cluster==c) %>% 
    ggplot(aes(x=day, y=abund_ln, color=label)) +
    geom_smooth(method="loess", se=F) +
    labs(title=title) +
    theme_test() +
    theme(legend.position = "none")
  print(p)
}

# Simplify further
abund_clust %>% 
  ggplot(aes(x=day, y=abund_ln, color=cluster)) +
  geom_smooth(method="loess", se=F) +
  labs(title="All clusters, each summmarized into one smoothed spline") +
  theme_test() +
  theme(legend.position = "none")

abund_clust %>% 
  ggplot(aes(x=day, y=abund_ln, color=cluster)) +
  geom_smooth(method="loess", se=F) +
  labs(title="All clusters, each summmarized into one smoothed spline") +
  facet_wrap(~cluster) +
  theme_test() +
  theme(legend.position = "none")
```

## Offset

```{r}
# Calculate time series means
ts_mean <- abund_clust %>% 
  group_by(label) %>% 
  summarize(ts_mean = mean(abund_ln)) %>% 
  ungroup()

# Offset
abund_offset <- abund_clust %>% 
  left_join(ts_mean) %>% 
  mutate(abund_offset = abund_ln - ts_mean)

# Visualize

for (c in c(1:4)) { # each cluster
  title <- paste0("Cluster ", c)
  p <- abund_offset %>% 
    semi_join(rand10) %>% 
    filter(cluster==c) %>% 
    ggplot(aes(x=day, y=abund_offset, color=label)) +
    geom_point(alpha=0.5) +
    geom_line(aes(group=label), alpha=0.5) +
    labs(title=title) +
    theme_test() +
    theme(legend.position = "none")
  print(p)
}

for (c in c(1:4)) { # each cluster
  title <- paste0("Cluster ", c, " examples")
  p <- abund_offset %>% 
    semi_join(rand10) %>% 
    filter(cluster==c) %>% 
    ggplot(aes(x=day, y=abund_offset, color=label)) +
    geom_smooth(method="loess", se=F) +
    labs(title=title) +
    theme_test() +
    theme(legend.position = "none")
  print(p)
}

# Simplify further
abund_offset %>% 
  semi_join(rand10) %>% 
  ggplot(aes(x=day, y=abund_offset, color=cluster)) +
  geom_smooth(method="loess", se=F) +
  labs(title="All clusters, each summmarized into one smoothed spline") +
  theme_test() +
  theme(legend.position = "none")

abund_offset %>% 
  semi_join(rand10) %>% 
  ggplot(aes(x=day, y=abund_offset, color=cluster)) +
  geom_smooth(method="loess", se=F) +
  labs(title="All clusters, each summmarized into one smoothed spline") +
  facet_wrap(~cluster) +
  theme_test() +
  theme(legend.position = "none")
```

# Save data

Script is getting long and crowded so moving exploratory analyses into a new file.

```{r, eval=FALSE}
# Cluster mapping
saveRDS(cluster_mapping10, file="../data_intermediate/NIFA_clustmap_dtwhclust.Rmd")
```


